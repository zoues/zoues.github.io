<!DOCTYPE html>
<html lang=en>
<head>
    <!-- so meta -->
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="HandheldFriendly" content="True">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=5" />
    <meta name="description" content="接触kubernetes两年有余，从18年初加入kubernetes社区来算，已经一年半，或许是时候写点什么。简单文章如何写好，难点文章如何写透，或许是一种学问，打算推一个系列：《Kubernetes GO》算是对这两年的一个总结。 kubernetes 1.16已在前天正式发布， kubeadm是Kubernetes官方提供的用于快速安装Kubernetes集群的工具，其中kubespray比较">
<meta property="og:type" content="article">
<meta property="og:title" content="Kubernetes展望与思考之1.17初体验">
<meta property="og:url" content="https://zoues.com/posts/518ae459/index.html">
<meta property="og:site_name" content="zouyee">
<meta property="og:description" content="接触kubernetes两年有余，从18年初加入kubernetes社区来算，已经一年半，或许是时候写点什么。简单文章如何写好，难点文章如何写透，或许是一种学问，打算推一个系列：《Kubernetes GO》算是对这两年的一个总结。 kubernetes 1.16已在前天正式发布， kubeadm是Kubernetes官方提供的用于快速安装Kubernetes集群的工具，其中kubespray比较">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://s2.ax1x.com/2019/09/22/uSqqC4.png">
<meta property="og:image" content="https://s2.ax1x.com/2019/09/22/uSXDD1.png">
<meta property="article:published_time" content="2019-09-20T12:40:08.000Z">
<meta property="article:modified_time" content="2024-01-20T12:01:27.438Z">
<meta property="article:author" content="zouyee">
<meta property="article:tag" content="cloudnative">
<meta property="article:tag" content="kubernetes">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://s2.ax1x.com/2019/09/22/uSqqC4.png">
    
    
      
        
          <link rel="shortcut icon" href="/images/favicon.ico">
        
      
      
        
          <link rel="icon" type="image/png" href="/images/favicon-192x192.png" sizes="192x192">
        
      
      
        
          <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">
        
      
    
    <!-- title -->
    <title>Kubernetes展望与思考之1.17初体验</title>
    <!-- async scripts -->
    <!-- Google Analytics -->


    <!-- Umami Analytics -->


    <!-- styles -->
    
<link rel="stylesheet" href="/css/style.css">

    <!-- persian styles -->
    
    <!-- rss -->
    
    
      <link rel="alternate" href="/true" title="zouyee" type="application/atom+xml" />
    
	<!-- mathjax -->
	
<meta name="generator" content="Hexo 7.0.0"></head>

<body class="max-width mx-auto px3 ltr">
    
      <div id="header-post">
  <a id="menu-icon" href="#" aria-label="Menu"><i class="fa-solid fa-bars fa-lg"></i></a>
  <a id="menu-icon-tablet" href="#" aria-label="Menu"><i class="fa-solid fa-bars fa-lg"></i></a>
  <a id="top-icon-tablet" href="#" aria-label="Top" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');" style="display:none;"><i class="fa-solid fa-chevron-up fa-lg"></i></a>
  <span id="menu">
    <span id="nav">
      <ul>
        <!--
       --><li><a href="/">Home</a></li><!--
     --><!--
       --><li><a href="/about/">About</a></li><!--
     --><!--
       --><li><a href="/categories/">Category</a></li><!--
     --><!--
       --><li><a href="/archives/">Writing</a></li><!--
     --><!--
       --><li><a target="_blank" rel="noopener" href="http://github.com/zouyee">Projects</a></li><!--
     -->
      </ul>
    </span>
    <br/>
    <span id="actions">
      <ul>
        
        <li><a class="icon" aria-label="Previous post" href="/posts/35342369/"><i class="fa-solid fa-chevron-left" aria-hidden="true" onmouseover="$('#i-prev').toggle();" onmouseout="$('#i-prev').toggle();"></i></a></li>
        
        
        <li><a class="icon" aria-label="Next post" href="/posts/83a6312/"><i class="fa-solid fa-chevron-right" aria-hidden="true" onmouseover="$('#i-next').toggle();" onmouseout="$('#i-next').toggle();"></i></a></li>
        
        <li><a class="icon" aria-label="Back to top" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fa-solid fa-chevron-up" aria-hidden="true" onmouseover="$('#i-top').toggle();" onmouseout="$('#i-top').toggle();"></i></a></li>
        <li><a class="icon" aria-label="Share post" href="#"><i class="fa-solid fa-share-alt" aria-hidden="true" onmouseover="$('#i-share').toggle();" onmouseout="$('#i-share').toggle();" onclick="$('#share').toggle();return false;"></i></a></li>
      </ul>
      <span id="i-prev" class="info" style="display:none;">Previous post</span>
      <span id="i-next" class="info" style="display:none;">Next post</span>
      <span id="i-top" class="info" style="display:none;">Back to top</span>
      <span id="i-share" class="info" style="display:none;">Share post</span>
    </span>
    <br/>
    <div id="share" style="display: none">
      <ul>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.facebook.com/sharer.php?u=https://zoues.com/posts/518ae459/"><i class="fab fa-facebook " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://twitter.com/share?url=https://zoues.com/posts/518ae459/&text=Kubernetes展望与思考之1.17初体验"><i class="fab fa-twitter " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.linkedin.com/shareArticle?url=https://zoues.com/posts/518ae459/&title=Kubernetes展望与思考之1.17初体验"><i class="fab fa-linkedin " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://pinterest.com/pin/create/bookmarklet/?url=https://zoues.com/posts/518ae459/&is_video=false&description=Kubernetes展望与思考之1.17初体验"><i class="fab fa-pinterest " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=Kubernetes展望与思考之1.17初体验&body=Check out this article: https://zoues.com/posts/518ae459/"><i class="fa-solid fa-envelope " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://getpocket.com/save?url=https://zoues.com/posts/518ae459/&title=Kubernetes展望与思考之1.17初体验"><i class="fab fa-get-pocket " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://reddit.com/submit?url=https://zoues.com/posts/518ae459/&title=Kubernetes展望与思考之1.17初体验"><i class="fab fa-reddit " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.stumbleupon.com/submit?url=https://zoues.com/posts/518ae459/&title=Kubernetes展望与思考之1.17初体验"><i class="fab fa-stumbleupon " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://digg.com/submit?url=https://zoues.com/posts/518ae459/&title=Kubernetes展望与思考之1.17初体验"><i class="fab fa-digg " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.tumblr.com/share/link?url=https://zoues.com/posts/518ae459/&name=Kubernetes展望与思考之1.17初体验&description="><i class="fab fa-tumblr " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://news.ycombinator.com/submitlink?u=https://zoues.com/posts/518ae459/&t=Kubernetes展望与思考之1.17初体验"><i class="fab fa-hacker-news " aria-hidden="true"></i></a></li>
</ul>

    </div>
    
    
      <div id="toc">
        <ol class="toc"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-16%E7%89%88%E6%9C%AC%E5%9B%9E%E9%A1%BE"><span class="toc-number">1.</span> <span class="toc-text">1.16版本回顾</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%89%8D%E6%9C%9F%E5%87%86%E5%A4%87"><span class="toc-number">2.</span> <span class="toc-text">前期准备</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E4%B8%8B%E8%BD%BD%E7%BC%96%E8%AF%91%E9%95%9C%E5%83%8F"><span class="toc-number">2.1.</span> <span class="toc-text">下载编译镜像*</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E7%BC%96%E8%AF%91%E4%BB%A3%E7%A0%81"><span class="toc-number">2.2.</span> <span class="toc-text">编译代码</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#kubeadm-%E6%88%90%E7%86%9F%E7%A8%8B%E5%BA%A6"><span class="toc-number">2.2.1.</span> <span class="toc-text">kubeadm 成熟程度</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E7%BB%B4%E6%8A%A4%E5%91%A8%E6%9C%9F"><span class="toc-number">2.2.2.</span> <span class="toc-text">维护周期</span></a></li></ol></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%B3%BB%E7%BB%9F%E9%85%8D%E7%BD%AE"><span class="toc-number">3.</span> <span class="toc-text">系统配置</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E8%AE%BE%E7%BD%AE%E9%98%B2%E7%81%AB%E5%A2%99"><span class="toc-number">3.1.</span> <span class="toc-text">设置防火墙</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E7%A6%81%E7%94%A8SElinux"><span class="toc-number">3.2.</span> <span class="toc-text">禁用SElinux</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%86%85%E6%A0%B8%E9%85%8D%E7%BD%AE"><span class="toc-number">3.3.</span> <span class="toc-text">内核配置</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E7%A3%81%E7%9B%98%E9%85%8D%E7%BD%AE"><span class="toc-number">3.4.</span> <span class="toc-text">磁盘配置</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%AE%B9%E5%99%A8%E5%BC%95%E6%93%8E%E5%AE%89%E8%A3%85"><span class="toc-number">3.5.</span> <span class="toc-text">容器引擎安装</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-%E4%BD%BF%E7%94%A8kubeadm%E9%83%A8%E7%BD%B2kubernetes"><span class="toc-number">4.</span> <span class="toc-text">2. 使用kubeadm部署kubernetes</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#2-1-%E5%AE%89%E8%A3%85kubeadm%E5%8F%8Akubelet"><span class="toc-number">4.1.</span> <span class="toc-text">2.1 安装kubeadm及kubelet</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#2-2-kubeadm%E5%88%9D%E5%A7%8B%E5%8C%96"><span class="toc-number">4.2.</span> <span class="toc-text">2.2 kubeadm初始化</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E8%AE%BF%E9%97%AE%E9%9B%86%E7%BE%A4"><span class="toc-number">4.3.</span> <span class="toc-text">访问集群</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E9%AA%8C%E8%AF%81%E9%9B%86%E7%BE%A4"><span class="toc-number">4.4.</span> <span class="toc-text">验证集群</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%8A%A0%E5%85%A5%E8%8A%82%E7%82%B9"><span class="toc-number">4.5.</span> <span class="toc-text">加入节点</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E9%AA%8C%E8%AF%81etcd%E5%AE%89%E8%A3%85"><span class="toc-number">4.6.</span> <span class="toc-text">验证etcd安装*</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E9%9B%86%E7%BE%A4%E9%87%8D%E7%BD%AE"><span class="toc-number">4.7.</span> <span class="toc-text">集群重置*</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%AE%89%E8%A3%85%E7%BD%91%E7%BB%9C"><span class="toc-number">4.8.</span> <span class="toc-text">安装网络</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%B5%8B%E8%AF%95%E7%BD%91%E7%BB%9C%E5%8F%8Adns"><span class="toc-number">4.9.</span> <span class="toc-text">测试网络及dns</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%83%A8%E7%BD%B2%E6%8F%92%E4%BB%B6"><span class="toc-number">5.</span> <span class="toc-text">部署插件*</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E8%BD%AF%E4%BB%B6%E5%8C%85%E7%AE%A1%E7%90%86"><span class="toc-number">5.1.</span> <span class="toc-text">软件包管理</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E9%83%A8%E7%BD%B2%E6%A0%B8%E5%BF%83%E7%9B%91%E6%8E%A7"><span class="toc-number">5.2.</span> <span class="toc-text">部署核心监控</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E9%83%A8%E7%BD%B2%E4%BB%AA%E8%A1%A8%E7%9B%98"><span class="toc-number">5.3.</span> <span class="toc-text">部署仪表盘</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%90%8E%E7%BB%AD"><span class="toc-number">5.4.</span> <span class="toc-text">后续</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%8F%82%E8%80%83%E8%B5%84%E6%96%99"><span class="toc-number">6.</span> <span class="toc-text">参考资料</span></a></li></ol>
      </div>
    
  </span>
</div>

    
    <div class="content index py4 ">
        
        <article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">
  <header>
    
    <h1 class="posttitle p-name" itemprop="name headline">
        Kubernetes展望与思考之1.17初体验
    </h1>



    <div class="meta">
      <span class="author p-author h-card" itemprop="author" itemscope itemtype="http://schema.org/Person">
        <span class="p-name" itemprop="name">zouyee</span>
      </span>
      
    <div class="postdate">
      
        <time datetime="2019-09-20T12:40:08.000Z" class="dt-published" itemprop="datePublished">2019-09-20</time>
        
      
    </div>


      

      
    <div class="article-tag">
        <i class="fa-solid fa-tag"></i>
        <a class="p-category" href="/tags/cloudnative/" rel="tag">cloudnative</a>, <a class="p-category" href="/tags/kubernetes/" rel="tag">kubernetes</a>
    </div>


    </div>
  </header>
  

  <div class="content e-content" itemprop="articleBody">
    <p>接触kubernetes两年有余，从18年初加入kubernetes社区来算，已经一年半，或许是时候写点什么。简单文章如何写好，难点文章如何写透，或许是一种学问，打算推一个系列：《Kubernetes GO》算是对这两年的一个总结。</p>
<p><a target="_blank" rel="noopener" href="https://kubernetes.io/blog/2019/09/18/kubernetes-1-16-release-announcement">kubernetes 1.16</a>已在前天正式发布，</p>
<p>kubeadm是Kubernetes官方提供的用于快速安装Kubernetes集群的工具，其中<a target="_blank" rel="noopener" href="https://github.com/kubernetes-sigs/kubespray">kubespray</a>比较适合较大规模的集群部署，*步骤，为可选操作，该文章主要介绍，以下内容:</p>
<ul>
<li>kubernetes编译</li>
<li>kubernetes部署</li>
<li>kubernetes测试(待续)</li>
</ul>
<p>下面我们看看如何编译及部署,在使用kubeadm部署前，需要编译以下镜像及执行文件,下面我们以v1.17.0-alpha.0版本为例：</p>
<ol>
<li><p>通过关注右侧公众号，输出<code>1.17a</code> 获取下面的基础镜像<br> 其中prepare.tgz为编译基础镜像，117alpha.tgz为v1.17.0-alpha.0所需镜像及二进制文件</p>
</li>
<li><p><code>golang 1.12.9+</code></p>
</li>
<li><p><code>ip、iptables、ipset、mount、nsenter、ebtables、ethtool, socat, tc、touch、conntrack、ipvsadm、jq、sysstat、curl、libseccomp</code> 等命令行</p>
</li>
</ol>
<hr>
<h4 id="1-16版本回顾"><a href="#1-16版本回顾" class="headerlink" title="1.16版本回顾"></a>1.16版本回顾</h4><blockquote>
<p>9月18日，Kubernetes 1.16正式发布，其包含31项增强功能，其中8项增强功能已经GA，另有8项增强功能处于beta阶段，15项处于alpha阶段，该版本有以下亮点:</p>
</blockquote>
<ul>
<li><p>自定义资源(CRD)</p>
<p>  CRD作为Kubernetes的可扩展机制之一得到广泛使用，其自1.7版本发布以来就一直处于beta阶段。Kubernetes 1.16版本，也标志着CRD迎来了GA版本。</p>
</li>
<li><p>存储卷扩展</p>
<p>  新版本当中包含一系列与存储卷以及卷修改相关的功能。CSI规范中的存储卷大小调整能力提升为beta阶段，允许用户对CSI规范下的存储卷插件进行大小调整。</p>
</li>
<li><p>拓扑管理[alpha]</p>
<p>  Kubelet中旨在协调资源分配决策，从而提供优化效果更好的资源分配能力</p>
</li>
<li><p>双栈[alpha]</p>
<p>  IPv4&#x2F;IPv6双栈可以将IPv4与IPv6地址分配给各Pod与服务</p>
</li>
</ul>
<p> <strong>若只需要部署v1.17.0-alpha.0版本，可跳过编译过程。</strong><br></br></p>
<h4 id="前期准备"><a href="#前期准备" class="headerlink" title="前期准备"></a>前期准备</h4><p><a target="_blank" rel="noopener" href="https://github.com/kubernetes/kubernetes/tree/master/build">社区</a>的文档介绍了如果编译相关镜像等工作，如果有兴趣，可仔细阅读，确认golang版本<code>go version</code> &gt;&#x3D; 1.12.9：</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://golang.org/doc/install">golang install</a></li>
</ul>
<h5 id="下载编译镜像"><a href="#下载编译镜像" class="headerlink" title="下载编译镜像*"></a>下载编译镜像*</h5><p>目前基础镜像为<code>k8s.gcr.io/kube-cross:v1.12.9-1</code>,如果需要确认读者目前所需镜像，在执行<code>KUBE_GIT_VERSION=v1.17.0-alpha.0 KUBE_FASTBUILD=true  KUBE_BUILD_PULL_LATEST_IMAGES=n make release-images</code>时需要，若本地不存在该镜像，会出现报错，因某种不可抗力因数，需要使用代理进行镜像拉取</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://github.com/Azure/container-service-for-azure-china/blob/master/aks/README.md#22-container-registry-proxy">Azure 中国镜像 <code>https://gcr.azk8s.cn</code></a></li>
<li><a target="_blank" rel="noopener" href="https://cr.console.aliyun.com/cn-hangzhou/mirrors">阿里云加速器(需登录获取)</a></li>
</ul>
<p>国内无法直接获取 <code>gcr.io/*</code> 镜像，我们可以将 <code>gcr.io/&lt;repo-name&gt;/&lt;image-name&gt;:&lt;version&gt;</code> 替换为 <code>gcr.azk8s.cn/&lt;repo-name&gt;/&lt;image-name&gt;:&lt;version&gt;</code> ,例如</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># $ docker pull k8s.gcr.io/kube-cross:v1.12.9-1</span></span><br><span class="line"><span class="comment"># k8s.gcr.io可以转换为gcr.io/google_containers</span></span><br><span class="line">$ docker pull gcr.azk8s.cn/google_containers/kube-cross:v1.12.9-1</span><br><span class="line">$ docker tag gcr.azk8s.cn/google_containers/kube-cross:v1.12.9-1 k8s.gcr.io/kube-cross:v1.12.9-1</span><br></pre></td></tr></table></figure>

<h5 id="编译代码"><a href="#编译代码" class="headerlink" title="编译代码"></a>编译代码</h5><p>下面切换到$GOPATH&#x2F;src&#x2F;k8s.io目录，如无则创建，执行<code>git clone https://github.com/kubernetes/kubernetes</code>,<br>下载完成后，切换到该目录，执行以下操作</p>
<ul>
<li><p>获取基础镜像</p>
<p> 通过右侧公众号获取的下载链接，解压<code>prepare.tgz</code>，解压加载以下面的基础镜像</p>
</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">tar -zxvf prepare.tgz</span><br><span class="line"><span class="comment"># docker load -i 解压的tar包，最终得到下列镜像</span></span><br><span class="line">k8s.gcr.io/kube-cross                       v1.12.9-1   a808db72440c    5 weeks ago         1.87GB</span><br><span class="line">k8s.gcr.io/debian-iptables-amd64            v11.0.2     01a746008995    5 months ago        45.4MB</span><br><span class="line">k8s.gcr.io/debian-base-amd64                v1.0.0      204e96332c91    5 months ago        42.3MB</span><br><span class="line">k8s.gcr.io/debian-hyperkube-base-amd64      v0.12.1     a46476511725    7 months ago        393MB</span><br></pre></td></tr></table></figure>

<ul>
<li>修改设置<br>确认<code>bash --version</code> &gt; 4.3,否则出现以下问题</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">/root/go/src/k8s.io/kubernetes/build/lib/release.sh:行385: docker_build_opts[@]: 为绑定变量</span><br><span class="line">/root/go/src/k8s.io/kubernetes/build/lib/release.sh:行385: docker_build_opts[@]: 为绑定变量</span><br><span class="line">/root/go/src/k8s.io/kubernetes/build/lib/release.sh:行385: docker_build_opts[@]: 为绑定变量</span><br><span class="line">/root/go/src/k8s.io/kubernetes/build/lib/release.sh:行385: docker_build_opts[@]: 为绑定变量</span><br></pre></td></tr></table></figure>
<p>  若不打算更新bash，则做以下修改：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">git diff build/lib/release.sh</span><br><span class="line">diff --git a/build/lib/release.sh b/build/lib/release.sh</span><br><span class="line">index 73c0bcc..e7bd1b1 100644</span><br><span class="line">--- a/build/lib/release.sh</span><br><span class="line">+++ b/build/lib/release.sh</span><br><span class="line">@@ -382,7 +382,7 @@ EOF</span><br><span class="line">         <span class="keyword">if</span> [[ <span class="string">&quot;<span class="variable">$&#123;KUBE_BUILD_PULL_LATEST_IMAGES&#125;</span>&quot;</span> =~ [yY] ]]; <span class="keyword">then</span></span><br><span class="line">             docker_build_opts+=(<span class="string">&quot;--pull&quot;</span>)</span><br><span class="line">         <span class="keyword">fi</span></span><br><span class="line">-        <span class="string">&quot;<span class="variable">$&#123;DOCKER[@]&#125;</span>&quot;</span> build <span class="string">&quot;<span class="variable">$&#123;docker_build_opts[@]&#125;</span>&quot;</span> -q -t <span class="string">&quot;<span class="variable">$&#123;docker_image_tag&#125;</span>&quot;</span> <span class="string">&quot;<span class="variable">$&#123;docker_build_path&#125;</span>&quot;</span> &gt;/dev/null</span><br><span class="line">+        <span class="string">&quot;<span class="variable">$&#123;DOCKER[@]&#125;</span>&quot;</span> build -q -t <span class="string">&quot;<span class="variable">$&#123;docker_image_tag&#125;</span>&quot;</span> <span class="string">&quot;<span class="variable">$&#123;docker_build_path&#125;</span>&quot;</span> &gt;/dev/null</span><br></pre></td></tr></table></figure>

<p>修改完记得提交，若编译前，对代码有改动，且未提交,即未执行<code>git commit</code>操作,执行编译<code>KUBE_GIT_VERSION=v1.17.0-alpha.0 KUBE_FASTBUILD=true  KUBE_BUILD_PULL_LATEST_IMAGES=n make release-images</code>,则生成的镜像即版本为dirty版本，其他编译操作参见下面链接：</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://github.com/kubernetes/kubernetes/blob/master/README.md">https://github.com/kubernetes/kubernetes</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/kubernetes/kubernetes/tree/master/build">https://github.com/kubernetes/kubernetes/tree/master/build</a></li>
</ul>
<p>若编译前，对代码有改动，且未提交，即未执行<code>git commit</code>操作，则生成的镜像即版本为dirty版本，执行下述命令(可执行bash -x)：</p>
<p><img src="https://s2.ax1x.com/2019/09/22/uSqqC4.png" alt="编译过程"></p>
<p><strong><strong>最终生成以下镜像结果</strong></strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">ls</span> _output/release-images/amd64/</span><br><span class="line">conformance-amd64.tar  kube-apiserver.tar           kube-proxy.tar</span><br><span class="line">hyperkube-amd64.tar    kube-controller-manager.tar  kube-scheduler.tar</span><br></pre></td></tr></table></figure>

<p><strong><strong>下面为二进制执行文件</strong></strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">ls</span> _output/dockerized/bin/linux/amd64/</span><br><span class="line">apiextensions-apiserver  e2e.test            genyaml     hyperkube                kubelet         mounter</span><br><span class="line">conversion-gen           gendocs             ginkgo      kubeadm                  kubemark        openapi-gen</span><br><span class="line">deepcopy-gen             genkubedocs         go2make     kube-apiserver           kube-proxy</span><br><span class="line">defaulter-gen            genman              go-bindata  kube-controller-manager  kube-scheduler</span><br><span class="line">e2e_node.test            genswaggertypedocs  go-runner   kubectl                  linkcheck</span><br><span class="line"><span class="comment"># 将kubelet、kubeadm、kubectl拷贝到/usr/bin/目录</span></span><br></pre></td></tr></table></figure>

<p>下述表单为kubeadm及kubernetes维护时限</p>
<h6 id="kubeadm-成熟程度"><a href="#kubeadm-成熟程度" class="headerlink" title="kubeadm 成熟程度"></a>kubeadm 成熟程度</h6><table>
<thead>
<tr>
<th>功能</th>
<th>成熟程度</th>
</tr>
</thead>
<tbody><tr>
<td>命令行用户体验</td>
<td>beta</td>
</tr>
<tr>
<td>功能实现</td>
<td>beta</td>
</tr>
<tr>
<td>配置文件 API</td>
<td>alpha</td>
</tr>
<tr>
<td>自托管</td>
<td>alpha</td>
</tr>
<tr>
<td>kubeadm alpha 子命令</td>
<td>alpha</td>
</tr>
<tr>
<td>CoreDNS</td>
<td>GA</td>
</tr>
<tr>
<td>动态 Kubelet 配置</td>
<td>alpha</td>
</tr>
</tbody></table>
<h6 id="维护周期"><a href="#维护周期" class="headerlink" title="维护周期"></a>维护周期</h6><p>Kubernetes 发现版本的通常只维护支持九个月，在维护周期内，如果发现有比较重大的 bug 或者安全问题的话，<br>可能会发布一个补丁版本。下面是 Kubernetes 的发布和维护周期，同时也适用于 <code>kubeadm</code>。</p>
<table>
<thead>
<tr>
<th>Kubernetes 版本</th>
<th>发行月份</th>
<th>终止维护月份</th>
</tr>
</thead>
<tbody><tr>
<td>v1.10.x</td>
<td>2018 年 3 月</td>
<td>2018 年 12 月</td>
</tr>
<tr>
<td>v1.11.x</td>
<td>2018 年 6 月</td>
<td>2019 年 3 月</td>
</tr>
<tr>
<td>v1.12.x</td>
<td>2018 年 9 月</td>
<td>2019 年 6 月</td>
</tr>
<tr>
<td>v1.13.x</td>
<td>2018 年 12 月</td>
<td>2019 年 9 月</td>
</tr>
<tr>
<td>v1.14.x</td>
<td>2019 年 3 月</td>
<td>2019 年 12 月</td>
</tr>
<tr>
<td>v1.15.x</td>
<td>2019 年 6 月</td>
<td>2020 年 3 月</td>
</tr>
<tr>
<td>v1.16.x</td>
<td>2019 年 9 月</td>
<td>2020 年 6 月</td>
</tr>
</tbody></table>
<hr>
<h4 id="系统配置"><a href="#系统配置" class="headerlink" title="系统配置"></a>系统配置</h4><p>在安装之前，需要做一些设置处理，当前准备两台CentOS 7.x如下所示：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cat</span> /etc/hosts</span><br><span class="line">10.142.21.132 kargo</span><br><span class="line">10.142.114.189 paasn1</span><br></pre></td></tr></table></figure>

<p>下面需要对各主机进行安装前<a target="_blank" rel="noopener" href="https://kubernetes.io/docs/setup/production-environment/tools/kubeadm/install-kubeadm">检查</a></p>
<h5 id="设置防火墙"><a href="#设置防火墙" class="headerlink" title="设置防火墙"></a>设置防火墙</h5><p>简单起见，可以关闭所有节点的防火墙：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">systemctl stop firewalld</span><br><span class="line">systemctl <span class="built_in">disable</span> firewalld</span><br></pre></td></tr></table></figure>

<h5 id="禁用SElinux"><a href="#禁用SElinux" class="headerlink" title="禁用SElinux"></a>禁用SElinux</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 临时禁用selinux</span></span><br><span class="line">setenforce 0</span><br><span class="line"><span class="comment"># 永久禁用selinux</span></span><br><span class="line">vi /etc/selinux/config</span><br><span class="line">SELINUX=disabled</span><br></pre></td></tr></table></figure>

<h5 id="内核配置"><a href="#内核配置" class="headerlink" title="内核配置"></a>内核配置</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cat</span> &lt;&lt;<span class="string">EOF &gt;  /etc/sysctl.d/k8s.conf</span></span><br><span class="line"><span class="string">net.bridge.bridge-nf-call-ip6tables = 1</span></span><br><span class="line"><span class="string">net.bridge.bridge-nf-call-iptables = 1</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line">sysctl -p /etc/sysctl.d/k8s.conf</span><br></pre></td></tr></table></figure>

<p>确认br_netfilter模块<br><code>lsmod | grep br_netfilter</code></p>
<p>启用此内核模块，以便遍历桥的数据包​​由iptables进行处理以进行过滤和端口转发，并且群集中的kubernetes窗格可以相互通信<br><code>modprobe br_netfilter</code></p>
<p>安装依赖命令行</p>
<p>yum install -y conntrack ipvsadm ipset jq sysstat curl iptables libseccomp socat -y</p>
<p>若kube-proxy需要开启ipvs，则下述模块需要存在</p>
<ul>
<li>ip_vs</li>
<li>ip_vs_rr</li>
<li>ip_vs_wrr</li>
<li>ip_vs_sh</li>
<li>nf_conntrack_ipv4</li>
</ul>
<p>可选：<br>   若kube-proxy需要开启ipvs，则下述模块需要存在, 在所有的Kubernetes节点kargo和paasn1上执行以下脚本</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cat</span> &gt; /etc/sysconfig/modules/ipvs.modules &lt;&lt;<span class="string">EOF</span></span><br><span class="line"><span class="string">#!/bin/bash</span></span><br><span class="line"><span class="string">modprobe -- ip_vs</span></span><br><span class="line"><span class="string">modprobe -- ip_vs_rr</span></span><br><span class="line"><span class="string">modprobe -- ip_vs_wrr</span></span><br><span class="line"><span class="string">modprobe -- ip_vs_sh</span></span><br><span class="line"><span class="string">modprobe -- nf_conntrack_ipv4</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line"><span class="built_in">chmod</span> 755 /etc/sysconfig/modules/ipvs.modules &amp;&amp; bash /etc/sysconfig/modules/ipvs.modules &amp;&amp; lsmod | grep -e ip_vs -e nf_conntrack_ipv4</span><br></pre></td></tr></table></figure>



<h5 id="磁盘配置"><a href="#磁盘配置" class="headerlink" title="磁盘配置"></a>磁盘配置</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 临时禁用swap即可，重启后，需要再此执行，当然也可以把磁盘信息写入/etc/fstab</span></span><br><span class="line">swapoff -a</span><br></pre></td></tr></table></figure>

<h5 id="容器引擎安装"><a href="#容器引擎安装" class="headerlink" title="容器引擎安装"></a>容器引擎安装</h5><p>从docker官方库安装kubernetes最新兼容性测试的匹配版本，Kubernetes 1.16+支持的docker版本列表依然是1.13.1, 17.03, 17.06, 17.09, 18.06, 18.09<br>安装docker-ce的软件包依赖,当前安装18.09.7：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">yum install -y yum-utils \</span><br><span class="line">  device-mapper-persistent-data \</span><br><span class="line">  lvm2</span><br><span class="line">yum-config-manager \</span><br><span class="line">    --add-repo \</span><br><span class="line">    https://download.docker.com/linux/centos/docker-ce.repo</span><br><span class="line"><span class="comment"># 18.09.7</span></span><br><span class="line">yum install docker-ce docker-ce-cli containerd.io -y</span><br><span class="line"><span class="comment"># 通过yum list docker-ce --showduplicates | sort -r 获取版本信息，执行以下命令安装指定版本</span></span><br><span class="line"><span class="comment"># yum install docker-ce-&lt;VERSION_STRING&gt; docker-ce-cli-&lt;VERSION_STRING&gt; containerd.i</span></span><br></pre></td></tr></table></figure>

<p>对于使用systemd作为的Linux的发行版，使用systemd作为docker的cgroup-river<br>可以确保服务器节点在资源紧张的情况更加稳定，因此这里修改各节点上docker的cgroup-driver为systemd。<br>创建&#x2F;etc&#x2F;docker&#x2F;daemon.json</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;exec-opts&quot;</span>: [<span class="string">&quot;native.cgroupdriver=systemd&quot;</span>]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>重启docker服务</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">systemctl restart docker</span><br><span class="line"><span class="comment"># 确认修改生效</span></span><br><span class="line">docker info | grep Cgroup</span><br><span class="line">Cgroup Driver: systemd</span><br><span class="line"><span class="comment"># enable 服务</span></span><br><span class="line">systemctl <span class="built_in">enable</span> docker</span><br></pre></td></tr></table></figure>

<hr>
<h4 id="2-使用kubeadm部署kubernetes"><a href="#2-使用kubeadm部署kubernetes" class="headerlink" title="2. 使用kubeadm部署kubernetes"></a>2. 使用kubeadm部署kubernetes</h4><p>以下为kubernetes 1.16+软件版本依赖信息：<br>执行<code>kubeadm config  images list</code>获取镜像版本信息</p>
<table>
<thead>
<tr>
<th>软件</th>
<th>版本或镜像</th>
</tr>
</thead>
<tbody><tr>
<td>apiserver</td>
<td>k8s.gcr.io&#x2F;kube-apiserver:v1.17.0-alpha.0</td>
</tr>
<tr>
<td>controller-manager</td>
<td>k8s.gcr.io&#x2F;kube-controller-manager:v1.17.0-alpha.0</td>
</tr>
<tr>
<td>scheduler</td>
<td>k8s.gcr.io&#x2F;kube-scheduler:v1.17.0-alpha.0</td>
</tr>
<tr>
<td>proxy</td>
<td>k8s.gcr.io&#x2F;kube-proxy:v1.17.0-alpha.0</td>
</tr>
<tr>
<td>pause</td>
<td>k8s.gcr.io&#x2F;pause:3.1</td>
</tr>
<tr>
<td>etcd</td>
<td>k8s.gcr.io&#x2F;etcd:3.3.15-0</td>
</tr>
<tr>
<td>coredns</td>
<td>k8s.gcr.io&#x2F;coredns:1.6.2</td>
</tr>
</tbody></table>
<p>同样kubernetes-cni-0.7.5-0.x86_64也需要安装</p>
<h5 id="2-1-安装kubeadm及kubelet"><a href="#2-1-安装kubeadm及kubelet" class="headerlink" title="2.1 安装kubeadm及kubelet"></a>2.1 安装kubeadm及kubelet</h5><p>所有节点执行以下操作:</p>
<ul>
<li>安装依赖软件<br>解压117alpha.tgz，<code>tar -xzvf 117alpha.tgz -C /root/</code>,切换至<code>/root/</code>目录<br>执行<code>rpm -ivh *.rpm</code></li>
<li>安装kubelet、kubeadm、kubectl<br>若已经执行编译操作，则该操作跳过<br>否则，将&#x2F;root&#x2F;下上述执行文件拷贝到&#x2F;usr&#x2F;bin&#x2F;目录下</li>
<li>创建kubelet.service<br>其中kubelet配置通过命令行–config指定配置文件,其内容在kubeadm执行时，进行初始化。具体查看官网<a target="_blank" rel="noopener" href="https://kubernetes.io/docs/tasks/administer-cluster/kubelet-config-file/">kubelet配置</a>。<br>Kubernetes关于为了Kubelet动态配置的特性当前为beta版本。</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cat</span> &lt;&lt;<span class="string">EOF &gt;/etc/systemd/system/kubelet.service.d/10-kubeadm.conf</span></span><br><span class="line"><span class="string"># Note: This dropin only works with kubeadm and kubelet v1.11+</span></span><br><span class="line"><span class="string">[Service]</span></span><br><span class="line"><span class="string">Environment=&quot;KUBELET_KUBECONFIG_ARGS=--v=6 --bootstrap-kubeconfig=/etc/kubernetes/bootstrap-kubelet.conf --kubeconfig=/etc/kubernetes/kubelet.conf&quot;</span></span><br><span class="line"><span class="string">Environment=&quot;KUBELET_CONFIG_ARGS=--config=/var/lib/kubelet/config.yaml&quot;</span></span><br><span class="line"><span class="string"># This is a file that &quot;kubeadm init&quot; and &quot;kubeadm join&quot; generates at runtime, populating the KUBELET_KUBEADM_ARGS variable dynamically</span></span><br><span class="line"><span class="string">EnvironmentFile=-/var/lib/kubelet/kubeadm-flags.env</span></span><br><span class="line"><span class="string"># This is a file that the user can use for overrides of the kubelet args as a last resort. Preferably, the user should use</span></span><br><span class="line"><span class="string"># the .NodeRegistration.KubeletExtraArgs object in the configuration files instead. KUBELET_EXTRA_ARGS should be sourced from this file.</span></span><br><span class="line"><span class="string">EnvironmentFile=-/etc/sysconfig/kubelet</span></span><br><span class="line"><span class="string">ExecStart=</span></span><br><span class="line"><span class="string">ExecStart=/usr/bin/kubelet $KUBELET_KUBECONFIG_ARGS $KUBELET_CONFIG_ARGS $KUBELET_KUBEADM_ARGS $KUBELET_EXTRA_ARGS</span></span><br><span class="line"><span class="string">EOF</span></span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cat</span> &lt;&lt;<span class="string">EOF &gt;/etc/systemd/system/kubelet.service</span></span><br><span class="line"><span class="string">[Unit]</span></span><br><span class="line"><span class="string">Description=kubelet: The Kubernetes Node Agent</span></span><br><span class="line"><span class="string">Documentation=http://kubernetes.io/docs/</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">[Service]</span></span><br><span class="line"><span class="string">ExecStart=/usr/bin/kubelet</span></span><br><span class="line"><span class="string">Restart=always</span></span><br><span class="line"><span class="string">StartLimitInterval=0</span></span><br><span class="line"><span class="string">RestartSec=10</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">[Install]</span></span><br><span class="line"><span class="string">WantedBy=multi-user.target</span></span><br><span class="line"><span class="string">EOF</span></span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># enable kubelet服务</span></span><br><span class="line">systemctl daemon-reloads</span><br><span class="line">systemctl <span class="built_in">enable</span> kubelet.service</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h5 id="2-2-kubeadm初始化"><a href="#2-2-kubeadm初始化" class="headerlink" title="2.2 kubeadm初始化"></a>2.2 kubeadm初始化</h5><p>使用kubeadm config print init-defaults可以打印集群初始化默认的使用的配置：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: kubeadm.k8s.io/v1beta2</span><br><span class="line">bootstrapTokens:</span><br><span class="line">- <span class="built_in">groups</span>:</span><br><span class="line">  - system:bootstrappers:kubeadm:default-node-token</span><br><span class="line">  token: abcdef.0123456789abcdef</span><br><span class="line">  ttl: 24h0m0s</span><br><span class="line">  usages:</span><br><span class="line">  - signing</span><br><span class="line">  - authentication</span><br><span class="line">kind: InitConfiguration</span><br><span class="line">localAPIEndpoint:</span><br><span class="line">  advertiseAddress: 1.2.3.4</span><br><span class="line">  bindPort: 6443</span><br><span class="line">nodeRegistration:</span><br><span class="line">  criSocket: /var/run/dockershim.sock</span><br><span class="line">  name: kargo</span><br><span class="line">  taints:</span><br><span class="line">  - effect: NoSchedule</span><br><span class="line">    key: node-role.kubernetes.io/master</span><br><span class="line">---</span><br><span class="line">apiServer:</span><br><span class="line">  timeoutForControlPlane: 4m0s</span><br><span class="line">apiVersion: kubeadm.k8s.io/v1beta2</span><br><span class="line">certificatesDir: /etc/kubernetes/pki</span><br><span class="line">clusterName: kubernetes</span><br><span class="line">controllerManager: &#123;&#125;</span><br><span class="line">dns:</span><br><span class="line">  <span class="built_in">type</span>: CoreDNS</span><br><span class="line">etcd:</span><br><span class="line">  <span class="built_in">local</span>:</span><br><span class="line">    dataDir: /var/lib/etcd</span><br><span class="line">imageRepository: k8s.gcr.io</span><br><span class="line">kind: ClusterConfiguration</span><br><span class="line">kubernetesVersion: v1.16.0</span><br><span class="line">networking:</span><br><span class="line">  dnsDomain: cluster.local</span><br><span class="line">  serviceSubnet: 10.96.0.0/12</span><br><span class="line">scheduler: &#123;&#125;</span><br></pre></td></tr></table></figure>

<p>其中镜像地址可通过imageRepository参数进行自定义，若本地已加载所需镜像，则无须改变，根据测试环境的实际情况,kubernetesVersion对应<code>kubeadm version</code>中GitVersion版本，将kubeadm.conf修改为：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cat</span> &lt;&lt;<span class="string">EOF &gt;/root/kubeadm.conf</span></span><br><span class="line"><span class="string">apiVersion: kubeadm.k8s.io/v1beta2</span></span><br><span class="line"><span class="string">bootstrapTokens:</span></span><br><span class="line"><span class="string">- groups:</span></span><br><span class="line"><span class="string">  - system:bootstrappers:kubeadm:default-node-token</span></span><br><span class="line"><span class="string">  token: abcdef.0123456789abcdef</span></span><br><span class="line"><span class="string">  ttl: 24h0m0s</span></span><br><span class="line"><span class="string">  usages:</span></span><br><span class="line"><span class="string">  - signing</span></span><br><span class="line"><span class="string">  - authentication</span></span><br><span class="line"><span class="string">kind: InitConfiguration</span></span><br><span class="line"><span class="string">localAPIEndpoint:</span></span><br><span class="line"><span class="string">  advertiseAddress: 10.142.21.132</span></span><br><span class="line"><span class="string">  bindPort: 6443</span></span><br><span class="line"><span class="string">nodeRegistration:</span></span><br><span class="line"><span class="string">  criSocket: /var/run/dockershim.sock</span></span><br><span class="line"><span class="string">  name: kargo</span></span><br><span class="line"><span class="string">  taints:</span></span><br><span class="line"><span class="string">  - effect: NoSchedule</span></span><br><span class="line"><span class="string">    key: node-role.kubernetes.io/master</span></span><br><span class="line"><span class="string">---</span></span><br><span class="line"><span class="string">apiServer:</span></span><br><span class="line"><span class="string">  timeoutForControlPlane: 4m0s</span></span><br><span class="line"><span class="string">apiVersion: kubeadm.k8s.io/v1beta2</span></span><br><span class="line"><span class="string">certificatesDir: /etc/kubernetes/pki</span></span><br><span class="line"><span class="string">clusterName: kubernetes</span></span><br><span class="line"><span class="string">controllerManager: &#123;&#125;</span></span><br><span class="line"><span class="string">dns:</span></span><br><span class="line"><span class="string">  type: CoreDNS</span></span><br><span class="line"><span class="string">etcd:</span></span><br><span class="line"><span class="string">  local:</span></span><br><span class="line"><span class="string">    dataDir: /var/lib/etcd</span></span><br><span class="line"><span class="string">imageRepository: k8s.gcr.io</span></span><br><span class="line"><span class="string">kind: ClusterConfiguration</span></span><br><span class="line"><span class="string">kubernetesVersion: v1.17.0-alpha.0</span></span><br><span class="line"><span class="string">networking:</span></span><br><span class="line"><span class="string">  dnsDomain: cluster.local</span></span><br><span class="line"><span class="string">  serviceSubnet: 10.96.0.0/12</span></span><br><span class="line"><span class="string">scheduler: &#123;&#125;</span></span><br><span class="line"><span class="string">EOF</span></span><br></pre></td></tr></table></figure>

<p>接下来使用kubeadm初始化集群，选择kargo作为Master Node，在kargo上执行下面的命令：<br><code>kubeadm init --config /root/kubeadm.conf</code><br>该命令会生成以下内容：</p>
<ul>
<li>[kubelet-start] 生成kubelet的配置文件”&#x2F;var&#x2F;lib&#x2F;kubelet&#x2F;config.yaml”</li>
<li>[kubeconfig]生成相关的kubeconfig文件</li>
<li>[control-plane]使用&#x2F;etc&#x2F;kubernetes&#x2F;manifests目录中的yaml文件创建apiserver、controller-manager、scheduler的静态pod</li>
<li>[bootstraptoken]生成token记录下来，后边使用kubeadm join往集群中添加节点时会用到</li>
<li>[certs]生成相关的各种证书</li>
</ul>
<h5 id="访问集群"><a href="#访问集群" class="headerlink" title="访问集群"></a>访问集群</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">mkdir</span> -p <span class="variable">$HOME</span>/.kube</span><br><span class="line"><span class="built_in">cp</span> -i /etc/kubernetes/admin.conf /root/.kube/config</span><br></pre></td></tr></table></figure>

<p>关于kubernetes的接入说明，具体可参看<a target="_blank" rel="noopener" href="https://kubernetes.io/docs/tasks/access-application-cluster/configure-access-multiple-clusters/">集群接入</a></p>
<h5 id="验证集群"><a href="#验证集群" class="headerlink" title="验证集群"></a>验证集群</h5><p>查看一下集群状态，确认个组件都处于healthy状态：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># kubectl cluster-info</span></span><br><span class="line">Kubernetes master is running at https://10.233.0.1</span><br><span class="line">CoreDNS is running at https://10.233.0.1/api/v1/namespaces/kube-system/services/kube-dns:dns/proxy</span><br><span class="line"></span><br><span class="line"><span class="comment"># kubectl get cs</span></span><br><span class="line">NAME                 STATUS    MESSAGE             ERROR</span><br><span class="line">controller-manager   Healthy   ok</span><br><span class="line">scheduler            Healthy   ok</span><br><span class="line">etcd-0               Healthy   &#123;<span class="string">&quot;health&quot;</span>:<span class="string">&quot;true&quot;</span>&#125;</span><br></pre></td></tr></table></figure>

<h5 id="加入节点"><a href="#加入节点" class="headerlink" title="加入节点"></a>加入节点</h5><p>若有详细了解<code>kubeadm join</code>命令的需求，可参看<a target="_blank" rel="noopener" href="https://kubernetes.io/docs/reference/setup-tools/kubeadm/kubeadm-join/">kubeadm join</a><br>加入集群，需要提供CA密钥的哈希，格式：sha256:<hex_encoded_hash>,在成功<code>kubeadm init</code>后，输出结果会显示合适的join命令，当然可以如下自己生成，</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 生成token</span></span><br><span class="line">kubeadm token create</span><br><span class="line">a9trii.8d52xbbusol0glji</span><br><span class="line"></span><br><span class="line">openssl x509 -pubkey -<span class="keyword">in</span> /etc/kubernetes/pki/ca.crt | openssl rsa -pubin -outform der 2&gt;/dev/null | openssl dgst -sha256 -hex | sed <span class="string">&#x27;s/^.* //&#x27;</span></span><br><span class="line">31b110e7fea9c86ddc6c1caa9f27f39021ea115ab7d2b5a86e157c42d9c8c57c</span><br><span class="line"></span><br><span class="line">kubeadm <span class="built_in">join</span> --discovery-token 9trii.8d52xbbusol0glji --discovery-token-ca-cert-hash sha256:31b110e7fea9c86ddc6c1caa9f27f39021ea115ab7d2b5a86e157c42d9c8c57c 10.142.21.132:6443 -v=6</span><br></pre></td></tr></table></figure>

<p>paasn1加入集群成功后，在kargo节点上执行命令查看集群中的节点：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">kubectl get node</span><br><span class="line">NAME    STATUS   ROLES    AGE   VERSION</span><br><span class="line">kargo   Ready    master   57m   v1.17.0-alpha.0</span><br><span class="line">passn1   Ready    &lt;none&gt;   11s   v1.17.0-alpha.0</span><br></pre></td></tr></table></figure>

<h5 id="验证etcd安装"><a href="#验证etcd安装" class="headerlink" title="验证etcd安装*"></a>验证etcd安装*</h5><p>如果配置正确，那么上述命令执行结果应该是任何输出的。如果结果有错，请参照上述配置和环境变量文件检查配置。一旦我们顺利启动<code>etcd</code>服务，我们还需要正确检查我们的<code>etcd</code>集群是否可用，在<code>etcd</code>集群中任一节点中执行以下命令：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">docker ps|grep etcd</span><br><span class="line">0214f9a78ba5        b2756210eeab                              <span class="string">&quot;etcd --advertise-cl…&quot;</span>   4 hours ago         Up 4 hours                              k8s_etcd_etcd-kargo_kube-system_2b66f634d9a00ad56540109b231dd318_3</span><br><span class="line">20419a0de748        k8s.gcr.io/pause:3.1                      <span class="string">&quot;/pause&quot;</span>                 9 days ago          Up 1 days                               k8s_POD_etcd-kargo_kube-system_2b66f634d9a00ad56540109b231dd318_2</span><br><span class="line"></span><br><span class="line"> docker <span class="built_in">exec</span> -it 168729f100e0 etcdctl --endpoint https://127.0.0.1:2379   \</span><br><span class="line"> --endpoint https://127.0.0.1:2379    \</span><br><span class="line"> --ca-file=/etc/ssl/etcd/ssl/ca.pem \</span><br><span class="line"> --cert-file=/etc/ssl/etcd/ssl/ca.pem \</span><br><span class="line"> --key-file=/etc/ssl/etcd/ssl/ca-key.pem \</span><br><span class="line"> cluster-health</span><br><span class="line"></span><br><span class="line"> member 38ee253c41f760ca is healthy: got healthy result from https://10.142.21.132:2379</span><br><span class="line"> cluster is healthy</span><br></pre></td></tr></table></figure>

<h5 id="集群重置"><a href="#集群重置" class="headerlink" title="集群重置*"></a>集群重置*</h5><p>集群初始化如果遇到问题，可以使用下面的命令进行清理</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">kubeadm reset</span><br><span class="line"><span class="built_in">rm</span> -rf /var/lib/cni/ /var/lib/etcd/</span><br><span class="line"><span class="built_in">rm</span> -rf /var/lib/kubelet /etc/kubernetes/</span><br></pre></td></tr></table></figure>

<h5 id="安装网络"><a href="#安装网络" class="headerlink" title="安装网络"></a>安装网络</h5><p>接下来，选择calico作为网络插件，具体说明，参见相关文档<a target="_blank" rel="noopener" href="https://kubernetes.io/docs/concepts/extend-kubernetes/compute-storage-net/network-plugins/">网络插件</a><br>其中calico部署简单如下所述：</p>
<ul>
<li>下载部署脚本<br>curl <a target="_blank" rel="noopener" href="https://docs.projectcalico.org/v3.9/manifests/calico.yaml">https://docs.projectcalico.org/v3.9/manifests/calico.yaml</a> -O</li>
<li>配置pod cidr<br>若pod cidr非192.168.0.0&#x2F;16，则执行以下命令</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">POD_CIDR=<span class="string">&quot;&lt;your-pod-cidr&gt;&quot;</span> \</span><br><span class="line">sed -i -e <span class="string">&quot;s?192.168.0.0/16?<span class="variable">$POD_CIDR</span>?g&quot;</span> calico.yaml</span><br></pre></td></tr></table></figure>

<p>相关文档，参见<a target="_blank" rel="noopener" href="https://docs.projectcalico.org/v3.9/getting-started/kubernetes/installation/calico">calico部署</a></p>
<ul>
<li>执行部署脚本<br><code>kubectl apply -f calico.yaml</code></li>
</ul>
<h5 id="测试网络及dns"><a href="#测试网络及dns" class="headerlink" title="测试网络及dns"></a>测试网络及dns</h5><p>首先，确认calico及coredns相关pod是否运行正确<br>在一切正常情况下，你会得到类似如下的输出结果:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#kubectl get po -n kube-system|grep calico</span></span><br><span class="line">calico-kube-controllers-744795b577-jc4r7                          1/1     Running                 0          1d</span><br><span class="line">calico-node-7lbdm                                                 1/1     Running                 8          1d</span><br><span class="line"></span><br><span class="line"><span class="comment">#kubectl get po -n kube-system|grep dns</span></span><br><span class="line">coredns-7f547f9899-7l9cq                                          1/1     Running                 0          1d</span><br><span class="line">dns-autoscaler-7bf66d8bd8-l52bn                                   1/1     Running                 0          1d</span><br><span class="line"></span><br><span class="line">kubectl run  busybox --image=busybox:latest --restart=Never</span><br></pre></td></tr></table></figure>

<p>进入busybox执行nslookup，查询kubernetes服务地址：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">kubectl run -it busybox sh</span><br><span class="line">nslookup kubernetes.default</span><br><span class="line"></span><br><span class="line">Server:    10.233.0.3</span><br><span class="line">Address 1: 10.233.0.3 kube-dns.kube-system.svc.cluster.local</span><br><span class="line"></span><br><span class="line">Name:      kubernetes.default</span><br><span class="line">Address 1: 10.233.0.3 kubernetes.default.svc.cluster.local</span><br><span class="line"></span><br><span class="line">ping 10.142.21.132</span><br><span class="line">若ping通，则网络正常</span><br></pre></td></tr></table></figure>

<h4 id="部署插件"><a href="#部署插件" class="headerlink" title="部署插件*"></a>部署插件*</h4><p>为了更好的管理与使用kubernetes集群，开源社区提供了多种工具，如应用管理、监控、日志、负载均衡等，另外kubernetes提供两种扩展方式：<a target="_blank" rel="noopener" href="https://kubernetes.io/docs/concepts/extend-kubernetes/api-extension/apiserver-aggregation/">使用聚合层</a>与<a target="_blank" rel="noopener" href="https://kubernetes.io/docs/concepts/extend-kubernetes/api-extension/custom-resources/">第三方资源管理</a></p>
<h5 id="软件包管理"><a href="#软件包管理" class="headerlink" title="软件包管理"></a>软件包管理</h5><p>Helm工具由Deis发起，该公司在17年初收购，该软件由客户端命helm令行工具和服务端tiller组成，Helm的安装十分简单。 下载helm命令行工具到master节点node1的&#x2F;usr&#x2F;local&#x2F;bin下，这里下载的2.14.3版本：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">curl -O https://get.helm.sh/helm-v2.14.3-linux-amd64.tar.gz</span><br><span class="line">tar -zxvf helm-v2.14.3-linux-amd64.tar.gz</span><br><span class="line"><span class="built_in">cd</span> linux-amd64/</span><br><span class="line"><span class="built_in">cp</span> helm /usr/local/bin/</span><br></pre></td></tr></table></figure>

<p>软件包的管理理念并不是Deis,这里势必需要提及一下mesosphere，其开创软件包c&#x2F;s管理模式，可惜在mesos vs kubernetes的战争中落败，而失去初始的光芒。<br>为了安装服务端tiller，需要在主机配置kubectl工具和kubeconfig文件，确保kubectl工具可以在这台机器上访问apiserver且正常使用。 这里的kargo节点已经配置好了kubectl。</p>
<p>因为Kubernetes APIServer开启了RBAC访问控制，所以需要创建tiller使用的service account: tiller并分配合适的角色给它。 详细内容可以查看helm文档中的<a target="_blank" rel="noopener" href="https://docs.helm.sh/using_helm/#role-based-access-control">RBAC</a>。 这里简单起见直接分配cluster-admin这个集群内置的ClusterRole给它。创建helm-rbac.yaml文件：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cat</span> &lt;&lt;<span class="string">EOF &gt;/root/helm.yaml</span></span><br><span class="line"><span class="string">apiVersion: v1</span></span><br><span class="line"><span class="string">kind: ServiceAccount</span></span><br><span class="line"><span class="string">metadata:</span></span><br><span class="line"><span class="string">  name: tiller</span></span><br><span class="line"><span class="string">  namespace: kube-system</span></span><br><span class="line"><span class="string">---</span></span><br><span class="line"><span class="string">apiVersion: rbac.authorization.k8s.io/v1beta1</span></span><br><span class="line"><span class="string">kind: ClusterRoleBinding</span></span><br><span class="line"><span class="string">metadata:</span></span><br><span class="line"><span class="string">  name: tiller</span></span><br><span class="line"><span class="string">roleRef:</span></span><br><span class="line"><span class="string">  apiGroup: rbac.authorization.k8s.io</span></span><br><span class="line"><span class="string">  kind: ClusterRole</span></span><br><span class="line"><span class="string">  name: cluster-admin</span></span><br><span class="line"><span class="string">subjects:</span></span><br><span class="line"><span class="string">  - kind: ServiceAccount</span></span><br><span class="line"><span class="string">    name: tiller</span></span><br><span class="line"><span class="string">    namespace: kube-system</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line"></span><br><span class="line">kubectl apply -f /root/helm.yaml</span><br></pre></td></tr></table></figure>

<p>接下来部署tiller：</p>
<p><code>helm init --service-account tiller --skip-refresh</code> tiller默认被部署在k8s集群中的kube-system这个namespace下：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">kubectl get pod -n kube-system -l app=helm</span><br><span class="line">NAME                             READY   STATUS    RESTARTS   AGE</span><br><span class="line">tiller-deploy-7d666f8ccc-92h27   1/1     Running   5          1d</span><br></pre></td></tr></table></figure>


<p>如上所述，使用代理镜像库<br>  helm init –service-account tiller –tiller-image &lt;你指定的镜像库名称&gt;&#x2F;tiller:v2.13.3 –skip-refresh<br>实际如下：<br>  helm init –service-account tiller –tiller-image gcr.azk8s.cn&#x2F;google_containers&#x2F;tiller:v2.13.1 –skip-refresh</p>
<p>修改helm charts仓库地址为微软提供的镜像地址：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">helm repo add stable http://mirror.azure.cn/kubernetes/charts</span><br><span class="line"><span class="string">&quot;stable&quot;</span> has been added to your repositories</span><br><span class="line"></span><br><span class="line">helm repo list</span><br><span class="line">NAME  URL</span><br><span class="line">stable http://mirror.azure.cn/kubernetes/charts</span><br><span class="line"><span class="built_in">local</span> http://127.0.0.1:8879/charts</span><br></pre></td></tr></table></figure>

<h5 id="部署核心监控"><a href="#部署核心监控" class="headerlink" title="部署核心监控"></a>部署核心监控</h5><p>kubernetes使用<a target="_blank" rel="noopener" href="https://github.com/kubernetes-incubator/metrics-server">metrics-server</a>提供节点及pod级别的资源监控, 其为<code>metrics.k8s.io</code>接口组，为弹性伸缩模块等模块提供接口，具体详见<a target="_blank" rel="noopener" href="https://github.com/kubernetes/community/blob/master/contributors/design-proposals/instrumentation/monitoring_architecture.md">kubernetes监控架构</a></p>
<ul>
<li>拉取代码<br><code>git clone https://github.com/kubernetes-incubator/metrics-server</code></li>
<li>修改配置<br> 修改<code>deploy/1.8+/metrics-server-deployment.yaml</code>文件</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">---</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: ServiceAccount</span><br><span class="line">metadata:</span><br><span class="line">  name: metrics-server</span><br><span class="line">  namespace: kube-system</span><br><span class="line">---</span><br><span class="line">apiVersion: apps/v1</span><br><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line">  name: metrics-server</span><br><span class="line">  namespace: kube-system</span><br><span class="line">  labels:</span><br><span class="line">    k8s-app: metrics-server</span><br><span class="line">spec:</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      k8s-app: metrics-server</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      name: metrics-server</span><br><span class="line">      labels:</span><br><span class="line">        k8s-app: metrics-server</span><br><span class="line">    spec:</span><br><span class="line">      serviceAccountName: metrics-server</span><br><span class="line">      volumes:</span><br><span class="line">      <span class="comment"># mount in tmp so we can safely use from-scratch images and/or read-only containers</span></span><br><span class="line">      - name: tmp-dir</span><br><span class="line">        emptyDir: &#123;&#125;</span><br><span class="line">      containers:</span><br><span class="line">      - name: metrics-server</span><br><span class="line">        image: k8s.gcr.io/metrics-server-amd64:v0.3.4</span><br><span class="line">        imagePullPolicy: Always</span><br><span class="line">        args:</span><br><span class="line">        - --logtostderr</span><br><span class="line">        - --kubelet-insecure-tls</span><br><span class="line">        - --kubelet-preferred-address-types=InternalIP</span><br><span class="line">        volumeMounts:</span><br><span class="line">        - name: tmp-dir</span><br><span class="line">          mountPath: /tmp</span><br></pre></td></tr></table></figure>

<ul>
<li>验证结果</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">kubectl get po -n kube-system -l k8s-app=metrics-server</span><br><span class="line">NAME                              READY   STATUS    RESTARTS   AGE</span><br><span class="line">metrics-server-66fc8cddfb-cwvcf   1/1     Running   6          1d</span><br><span class="line"></span><br><span class="line">kubectl top node</span><br><span class="line">NAME     CPU(cores)   CPU%   MEMORY(bytes)   MEMORY%</span><br><span class="line">kargo   1533m        19%    9430Mi          61%</span><br><span class="line">paasn1   4443m        56%    10490Mi         67%</span><br></pre></td></tr></table></figure>

<h5 id="部署仪表盘"><a href="#部署仪表盘" class="headerlink" title="部署仪表盘"></a>部署仪表盘</h5><p>社区提供Dashboard项目，它为用户提供一个可视化的Web界面来查看当前集群的各种信息。用户可以使用Kubernetes Dashboard部署容器化的应用、监控应用的状态、执行故障排查任务以及管理Kubernetes各类资源。部署方式如下；</p>
<ul>
<li>拉取代码<br><code>https://github.com/kubernetes/dashboard</code></li>
<li>修改配置<br>将<code>aio/deploy/recommended/02_dashboard-service.yaml</code>配置修改为：</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">kind: Service</span><br><span class="line">apiVersion: v1</span><br><span class="line">metadata:</span><br><span class="line">  labels:</span><br><span class="line">    k8s-app: kubernetes-dashboard</span><br><span class="line">  name: kubernetes-dashboard</span><br><span class="line">  namespace: kubernetes-dashboard</span><br><span class="line">spec:</span><br><span class="line">  ports:</span><br><span class="line">    - port: 443</span><br><span class="line">      targetPort: 8443</span><br><span class="line">  selector:</span><br><span class="line">    k8s-app: kubernetes-dashboard</span><br><span class="line">  <span class="built_in">type</span>: NodePort</span><br></pre></td></tr></table></figure>

<p>获取分配访问端口：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">kubectl get svc -n kubernetes-dashboard</span><br><span class="line">NAME                   TYPE       CLUSTER-IP     EXTERNAL-IP   PORT(S)         AGE</span><br><span class="line">kubernetes-dashboard   NodePort   10.233.41.73   &lt;none&gt;        443:30479/TCP   1d</span><br></pre></td></tr></table></figure>

<p>获得主机端口30479，dashboard的界面绕过https,通过<a target="_blank" rel="noopener" href="https://10.142.21.132:30479/">https://10.142.21.132:30479</a><a target="_blank" rel="noopener" href="https://kubernetes.io/docs/concepts/services-networking/service/">nodeport方式</a>进行访问外，还可以执行以下代理操作</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl proxy --accept-hosts=<span class="string">&#x27;^.*&#x27;</span> --address=<span class="string">&#x27;10.142.113.20&#x27;</span> --port 8080</span><br></pre></td></tr></table></figure>

<p>我们还可以通过<a target="_blank" rel="noopener" href="http://10.142.21.132:8080/api/v1/namespaces/kubernetes-dashboard/services/https:kubernetes-dashboard:/proxy/">http://10.142.21.132:8080/api/v1/namespaces/kubernetes-dashboard/services/https:kubernetes-dashboard:/proxy/</a><br>，如下图所示。</p>
<p><img src="https://s2.ax1x.com/2019/09/22/uSXDD1.png" alt="Dashboard UI workloads page"></p>
<h5 id="后续"><a href="#后续" class="headerlink" title="后续"></a>后续</h5><p>针对上述涉及的内容，请关注后续文章</p>
<h4 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h4><ul>
<li><a target="_blank" rel="noopener" href="https://kubernetes.io/blog/2019/09/18/kubernetes-1-16-release-announcement/">kubernetes 1.16</a></li>
<li><a target="_blank" rel="noopener" href="https://kubernetes.io/docs/reference/setup-tools/kubeadm">kubeadm</a></li>
<li><a target="_blank" rel="noopener" href="https://kubernetes.io/docs/reference/setup-tools/kubeadm/kubeadm-join/">kubeadm join</a></li>
<li><a target="_blank" rel="noopener" href="https://kubernetes.io/docs/concepts/extend-kubernetes/compute-storage-net/network-plugins/">网络插件</a></li>
<li><a target="_blank" rel="noopener" href="https://docs.projectcalico.org/v3.9/getting-started/kubernetes/installation/calico">calico部署</a></li>
<li><a target="_blank" rel="noopener" href="https://kubernetes.io/docs/tasks/access-application-cluster/configure-access-multiple-clusters/">集群接入</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/kubernetes/community/blob/master/contributors/design-proposals/instrumentation/monitoring_architecture.md">监控架构</a></li>
</ul>

  </div>
</article>



        
          <div id="footer-post-container">
  <div id="footer-post">

    <div id="nav-footer" style="display: none">
      <ul>
        
          <li><a href="/">Home</a></li>
        
          <li><a href="/about/">About</a></li>
        
          <li><a href="/categories/">Category</a></li>
        
          <li><a href="/archives/">Writing</a></li>
        
          <li><a target="_blank" rel="noopener" href="http://github.com/zouyee">Projects</a></li>
        
      </ul>
    </div>

    
    
      <div id="toc-footer" style="display: none">
        <ol class="toc"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-16%E7%89%88%E6%9C%AC%E5%9B%9E%E9%A1%BE"><span class="toc-number">1.</span> <span class="toc-text">1.16版本回顾</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%89%8D%E6%9C%9F%E5%87%86%E5%A4%87"><span class="toc-number">2.</span> <span class="toc-text">前期准备</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E4%B8%8B%E8%BD%BD%E7%BC%96%E8%AF%91%E9%95%9C%E5%83%8F"><span class="toc-number">2.1.</span> <span class="toc-text">下载编译镜像*</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E7%BC%96%E8%AF%91%E4%BB%A3%E7%A0%81"><span class="toc-number">2.2.</span> <span class="toc-text">编译代码</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#kubeadm-%E6%88%90%E7%86%9F%E7%A8%8B%E5%BA%A6"><span class="toc-number">2.2.1.</span> <span class="toc-text">kubeadm 成熟程度</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E7%BB%B4%E6%8A%A4%E5%91%A8%E6%9C%9F"><span class="toc-number">2.2.2.</span> <span class="toc-text">维护周期</span></a></li></ol></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%B3%BB%E7%BB%9F%E9%85%8D%E7%BD%AE"><span class="toc-number">3.</span> <span class="toc-text">系统配置</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E8%AE%BE%E7%BD%AE%E9%98%B2%E7%81%AB%E5%A2%99"><span class="toc-number">3.1.</span> <span class="toc-text">设置防火墙</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E7%A6%81%E7%94%A8SElinux"><span class="toc-number">3.2.</span> <span class="toc-text">禁用SElinux</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%86%85%E6%A0%B8%E9%85%8D%E7%BD%AE"><span class="toc-number">3.3.</span> <span class="toc-text">内核配置</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E7%A3%81%E7%9B%98%E9%85%8D%E7%BD%AE"><span class="toc-number">3.4.</span> <span class="toc-text">磁盘配置</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%AE%B9%E5%99%A8%E5%BC%95%E6%93%8E%E5%AE%89%E8%A3%85"><span class="toc-number">3.5.</span> <span class="toc-text">容器引擎安装</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-%E4%BD%BF%E7%94%A8kubeadm%E9%83%A8%E7%BD%B2kubernetes"><span class="toc-number">4.</span> <span class="toc-text">2. 使用kubeadm部署kubernetes</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#2-1-%E5%AE%89%E8%A3%85kubeadm%E5%8F%8Akubelet"><span class="toc-number">4.1.</span> <span class="toc-text">2.1 安装kubeadm及kubelet</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#2-2-kubeadm%E5%88%9D%E5%A7%8B%E5%8C%96"><span class="toc-number">4.2.</span> <span class="toc-text">2.2 kubeadm初始化</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E8%AE%BF%E9%97%AE%E9%9B%86%E7%BE%A4"><span class="toc-number">4.3.</span> <span class="toc-text">访问集群</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E9%AA%8C%E8%AF%81%E9%9B%86%E7%BE%A4"><span class="toc-number">4.4.</span> <span class="toc-text">验证集群</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%8A%A0%E5%85%A5%E8%8A%82%E7%82%B9"><span class="toc-number">4.5.</span> <span class="toc-text">加入节点</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E9%AA%8C%E8%AF%81etcd%E5%AE%89%E8%A3%85"><span class="toc-number">4.6.</span> <span class="toc-text">验证etcd安装*</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E9%9B%86%E7%BE%A4%E9%87%8D%E7%BD%AE"><span class="toc-number">4.7.</span> <span class="toc-text">集群重置*</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%AE%89%E8%A3%85%E7%BD%91%E7%BB%9C"><span class="toc-number">4.8.</span> <span class="toc-text">安装网络</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%B5%8B%E8%AF%95%E7%BD%91%E7%BB%9C%E5%8F%8Adns"><span class="toc-number">4.9.</span> <span class="toc-text">测试网络及dns</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%83%A8%E7%BD%B2%E6%8F%92%E4%BB%B6"><span class="toc-number">5.</span> <span class="toc-text">部署插件*</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E8%BD%AF%E4%BB%B6%E5%8C%85%E7%AE%A1%E7%90%86"><span class="toc-number">5.1.</span> <span class="toc-text">软件包管理</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E9%83%A8%E7%BD%B2%E6%A0%B8%E5%BF%83%E7%9B%91%E6%8E%A7"><span class="toc-number">5.2.</span> <span class="toc-text">部署核心监控</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E9%83%A8%E7%BD%B2%E4%BB%AA%E8%A1%A8%E7%9B%98"><span class="toc-number">5.3.</span> <span class="toc-text">部署仪表盘</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%90%8E%E7%BB%AD"><span class="toc-number">5.4.</span> <span class="toc-text">后续</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%8F%82%E8%80%83%E8%B5%84%E6%96%99"><span class="toc-number">6.</span> <span class="toc-text">参考资料</span></a></li></ol>
      </div>
    

    <div id="share-footer" style="display: none">
      <ul>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.facebook.com/sharer.php?u=https://zoues.com/posts/518ae459/"><i class="fab fa-facebook fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://twitter.com/share?url=https://zoues.com/posts/518ae459/&text=Kubernetes展望与思考之1.17初体验"><i class="fab fa-twitter fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.linkedin.com/shareArticle?url=https://zoues.com/posts/518ae459/&title=Kubernetes展望与思考之1.17初体验"><i class="fab fa-linkedin fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://pinterest.com/pin/create/bookmarklet/?url=https://zoues.com/posts/518ae459/&is_video=false&description=Kubernetes展望与思考之1.17初体验"><i class="fab fa-pinterest fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=Kubernetes展望与思考之1.17初体验&body=Check out this article: https://zoues.com/posts/518ae459/"><i class="fa-solid fa-envelope fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://getpocket.com/save?url=https://zoues.com/posts/518ae459/&title=Kubernetes展望与思考之1.17初体验"><i class="fab fa-get-pocket fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://reddit.com/submit?url=https://zoues.com/posts/518ae459/&title=Kubernetes展望与思考之1.17初体验"><i class="fab fa-reddit fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.stumbleupon.com/submit?url=https://zoues.com/posts/518ae459/&title=Kubernetes展望与思考之1.17初体验"><i class="fab fa-stumbleupon fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://digg.com/submit?url=https://zoues.com/posts/518ae459/&title=Kubernetes展望与思考之1.17初体验"><i class="fab fa-digg fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.tumblr.com/share/link?url=https://zoues.com/posts/518ae459/&name=Kubernetes展望与思考之1.17初体验&description="><i class="fab fa-tumblr fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://news.ycombinator.com/submitlink?u=https://zoues.com/posts/518ae459/&t=Kubernetes展望与思考之1.17初体验"><i class="fab fa-hacker-news fa-lg" aria-hidden="true"></i></a></li>
</ul>

    </div>

    <div id="actions-footer">
        <a id="menu" class="icon" href="#" onclick="$('#nav-footer').toggle();return false;"><i class="fa-solid fa-bars fa-lg" aria-hidden="true"></i> Menu</a>
        
          <a id="toc" class="icon" href="#" onclick="$('#toc-footer').toggle();return false;"><i class="fa-solid fa-list fa-lg" aria-hidden="true"></i> TOC</a>
        
        <a id="share" class="icon" href="#" onclick="$('#share-footer').toggle();return false;"><i class="fa-solid fa-share-alt fa-lg" aria-hidden="true"></i> Share</a>
        <a id="top" style="display:none" class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fa-solid fa-chevron-up fa-lg" aria-hidden="true"></i> Top</a>
    </div>

  </div>
</div>

        
        <footer id="footer">
  <div class="footer-left">
    Copyright &copy;
    
    
    2016-2024
    zouyee
  </div>
  <div class="footer-right">
    <nav>
      <ul>
        <!--
       --><li><a href="/">Home</a></li><!--
     --><!--
       --><li><a href="/about/">About</a></li><!--
     --><!--
       --><li><a href="/categories/">Category</a></li><!--
     --><!--
       --><li><a href="/archives/">Writing</a></li><!--
     --><!--
       --><li><a target="_blank" rel="noopener" href="http://github.com/zouyee">Projects</a></li><!--
     -->
      </ul>
    </nav>
  </div>
</footer>

    </div>
    <!-- styles -->



  <link rel="preload" as="style" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" crossorigin="anonymous" onload="this.onload=null;this.rel='stylesheet'"/>


    <!-- jquery -->

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js" crossorigin="anonymous"></script>




<!-- clipboard -->

  
    <script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.7/clipboard.min.js" crossorigin="anonymous"></script>
  
  <script type="text/javascript">
  $(function() {
    // copy-btn HTML
    var btn = "<span class=\"btn-copy tooltipped tooltipped-sw\" aria-label=\"Copy to clipboard!\">";
    btn += '<i class="fa-regular fa-clone"></i>';
    btn += '</span>';
    // mount it!
    $(".highlight table").before(btn);
    var clip = new ClipboardJS('.btn-copy', {
      text: function(trigger) {
        return Array.from(trigger.nextElementSibling.querySelectorAll('.code')).reduce((str,it)=>str+it.innerText+'\n','')
      }
    });
    clip.on('success', function(e) {
      e.trigger.setAttribute('aria-label', "Copied!");
      e.clearSelection();
    })
  })
  </script>


<script src="/js/main.js"></script>

<!-- search -->

<!-- Baidu Analytics -->

<!-- Cloudflare Analytics -->

<!-- Disqus Comments -->

<!-- utterances Comments -->

</body>
</html>
