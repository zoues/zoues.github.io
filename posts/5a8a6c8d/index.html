<!DOCTYPE html>
<html lang=en>
<head>
    <!-- so meta -->
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="HandheldFriendly" content="True">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=5" />
    <meta name="description" content="为了帮助读者深入了解Kubernetes在各种应用场景下所面临的挑战和解决方案，以及如何进行性能优化。我们推出了&lt;&lt;Kubernetes经典案例30篇&gt;&gt;，该系列涵盖了不同的使用场景，从runc到containerd，从K8s到Istio等微服务架构，全面展示了Kubernetes在实际应用中的最佳实践。通过这些案例，读者可以掌握如何应对复杂的技术难题，并提升Kuberne">
<meta property="og:type" content="article">
<meta property="og:title" content="一条K8s命令行引发的血案">
<meta property="og:url" content="https://zoues.com/posts/5a8a6c8d/index.html">
<meta property="og:site_name" content="zouyee">
<meta property="og:description" content="为了帮助读者深入了解Kubernetes在各种应用场景下所面临的挑战和解决方案，以及如何进行性能优化。我们推出了&lt;&lt;Kubernetes经典案例30篇&gt;&gt;，该系列涵盖了不同的使用场景，从runc到containerd，从K8s到Istio等微服务架构，全面展示了Kubernetes在实际应用中的最佳实践。通过这些案例，读者可以掌握如何应对复杂的技术难题，并提升Kuberne">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://pic.imgdb.cn/item/65b43ba0871b83018ac66a1f.png">
<meta property="article:published_time" content="2024-01-27T01:25:08.000Z">
<meta property="article:modified_time" content="2024-06-09T03:41:38.145Z">
<meta property="article:author" content="zouyee">
<meta property="article:tag" content="cloudnative">
<meta property="article:tag" content="kubernetes">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://pic.imgdb.cn/item/65b43ba0871b83018ac66a1f.png">
    
    
      
        
          <link rel="shortcut icon" href="/images/favicon.ico">
        
      
      
        
          <link rel="icon" type="image/png" href="/images/favicon-192x192.png" sizes="192x192">
        
      
      
        
          <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">
        
      
    
    <!-- title -->
    <title>一条K8s命令行引发的血案</title>
    <!-- async scripts -->
    <!-- Google Analytics -->


    <!-- Umami Analytics -->


    <!-- styles -->
    
<link rel="stylesheet" href="/css/style.css">

    <!-- persian styles -->
    
    <!-- rss -->
    
    
      <link rel="alternate" href="/true" title="zouyee" type="application/atom+xml" />
    
	<!-- mathjax -->
	
<meta name="generator" content="Hexo 7.1.1"></head>

<body class="max-width mx-auto px3 ltr">
    
      <div id="header-post">
  <a id="menu-icon" href="#" aria-label="Menu"><i class="fa-solid fa-bars fa-lg"></i></a>
  <a id="menu-icon-tablet" href="#" aria-label="Menu"><i class="fa-solid fa-bars fa-lg"></i></a>
  <a id="top-icon-tablet" href="#" aria-label="Top" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');" style="display:none;"><i class="fa-solid fa-chevron-up fa-lg"></i></a>
  <span id="menu">
    <span id="nav">
      <ul>
        <!--
       --><li><a href="/">Home</a></li><!--
     --><!--
       --><li><a href="/about/">About</a></li><!--
     --><!--
       --><li><a href="/categories/">Category</a></li><!--
     --><!--
       --><li><a href="/archives/">Writing</a></li><!--
     --><!--
       --><li><a target="_blank" rel="noopener" href="http://github.com/zouyee">Projects</a></li><!--
     -->
      </ul>
    </span>
    <br/>
    <span id="actions">
      <ul>
        
        <li><a class="icon" aria-label="Previous post" href="/posts/3f237e52/"><i class="fa-solid fa-chevron-left" aria-hidden="true" onmouseover="$('#i-prev').toggle();" onmouseout="$('#i-prev').toggle();"></i></a></li>
        
        
        <li><a class="icon" aria-label="Next post" href="/posts/423bdf96/"><i class="fa-solid fa-chevron-right" aria-hidden="true" onmouseover="$('#i-next').toggle();" onmouseout="$('#i-next').toggle();"></i></a></li>
        
        <li><a class="icon" aria-label="Back to top" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fa-solid fa-chevron-up" aria-hidden="true" onmouseover="$('#i-top').toggle();" onmouseout="$('#i-top').toggle();"></i></a></li>
        <li><a class="icon" aria-label="Share post" href="#"><i class="fa-solid fa-share-alt" aria-hidden="true" onmouseover="$('#i-share').toggle();" onmouseout="$('#i-share').toggle();" onclick="$('#share').toggle();return false;"></i></a></li>
      </ul>
      <span id="i-prev" class="info" style="display:none;">Previous post</span>
      <span id="i-next" class="info" style="display:none;">Next post</span>
      <span id="i-top" class="info" style="display:none;">Back to top</span>
      <span id="i-share" class="info" style="display:none;">Share post</span>
    </span>
    <br/>
    <div id="share" style="display: none">
      <ul>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.facebook.com/sharer.php?u=https://zoues.com/posts/5a8a6c8d/"><i class="fab fa-facebook " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://twitter.com/share?url=https://zoues.com/posts/5a8a6c8d/&text=一条K8s命令行引发的血案"><i class="fab fa-twitter " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.linkedin.com/shareArticle?url=https://zoues.com/posts/5a8a6c8d/&title=一条K8s命令行引发的血案"><i class="fab fa-linkedin " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://pinterest.com/pin/create/bookmarklet/?url=https://zoues.com/posts/5a8a6c8d/&is_video=false&description=一条K8s命令行引发的血案"><i class="fab fa-pinterest " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=一条K8s命令行引发的血案&body=Check out this article: https://zoues.com/posts/5a8a6c8d/"><i class="fa-solid fa-envelope " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://getpocket.com/save?url=https://zoues.com/posts/5a8a6c8d/&title=一条K8s命令行引发的血案"><i class="fab fa-get-pocket " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://reddit.com/submit?url=https://zoues.com/posts/5a8a6c8d/&title=一条K8s命令行引发的血案"><i class="fab fa-reddit " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.stumbleupon.com/submit?url=https://zoues.com/posts/5a8a6c8d/&title=一条K8s命令行引发的血案"><i class="fab fa-stumbleupon " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://digg.com/submit?url=https://zoues.com/posts/5a8a6c8d/&title=一条K8s命令行引发的血案"><i class="fab fa-digg " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.tumblr.com/share/link?url=https://zoues.com/posts/5a8a6c8d/&name=一条K8s命令行引发的血案&description="><i class="fab fa-tumblr " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://news.ycombinator.com/submitlink?u=https://zoues.com/posts/5a8a6c8d/&t=一条K8s命令行引发的血案"><i class="fab fa-hacker-news " aria-hidden="true"></i></a></li>
</ul>

    </div>
    
    
      <div id="toc">
        <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%80%E6%9D%A1K8s%E5%91%BD%E4%BB%A4%E8%A1%8C%E5%BC%95%E5%8F%91%E7%9A%84%E8%A1%80%E6%A1%88"><span class="toc-number">1.</span> <span class="toc-text">一条K8s命令行引发的血案</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%97%AE%E9%A2%98%E6%8F%8F%E8%BF%B0"><span class="toc-number">2.</span> <span class="toc-text">问题描述</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%8A%80%E6%9C%AF%E8%83%8C%E6%99%AF"><span class="toc-number">3.</span> <span class="toc-text">技术背景</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#cadvisor"><span class="toc-number">3.1.</span> <span class="toc-text">cadvisor</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Kubelet"><span class="toc-number">3.2.</span> <span class="toc-text">Kubelet</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#CPU-Load%E6%8C%87%E6%A0%87"><span class="toc-number">3.3.</span> <span class="toc-text">CPU Load指标</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AF%BB%E6%A0%B9%E6%BA%AF%E6%BA%90"><span class="toc-number">4.</span> <span class="toc-text">寻根溯源</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%BB%93%E8%AE%BA"><span class="toc-number">5.</span> <span class="toc-text">结论</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8F%82%E8%80%83%E9%93%BE%E6%8E%A5"><span class="toc-number">6.</span> <span class="toc-text">参考链接</span></a></li></ol>
      </div>
    
  </span>
</div>

    
    <div class="content index py4 ">
        
        <article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">
  <header>
    
    <h1 class="posttitle p-name" itemprop="name headline">
        一条K8s命令行引发的血案
    </h1>



    <div class="meta">
      <span class="author p-author h-card" itemprop="author" itemscope itemtype="http://schema.org/Person">
        <span class="p-name" itemprop="name">zouyee</span>
      </span>
      
    <div class="postdate">
      
        <time datetime="2024-01-27T01:25:08.000Z" class="dt-published" itemprop="datePublished">2024-01-27</time>
        
      
    </div>


      

      
    <div class="article-tag">
        <i class="fa-solid fa-tag"></i>
        <a class="p-category" href="/tags/cloudnative/" rel="tag">cloudnative</a>, <a class="p-category" href="/tags/kubernetes/" rel="tag">kubernetes</a>
    </div>


    </div>
  </header>
  

  <div class="content e-content" itemprop="articleBody">
    <p>为了帮助读者深入了解Kubernetes在各种应用场景下所面临的挑战和解决方案，以及如何进行性能优化。我们推出了<a href="/Kubernetes%E7%BB%8F%E5%85%B8%E6%A1%88%E4%BE%8B30%E7%AF%87/index.html">&lt;&lt;Kubernetes经典案例30篇&gt;&gt;</a>，该系列涵盖了不同的使用场景，从runc到containerd，从K8s到Istio等微服务架构，全面展示了Kubernetes在实际应用中的最佳实践。通过这些案例，读者可以掌握如何应对复杂的技术难题，并提升Kubernetes集群的性能和稳定性。</p>
<ol>
<li><a href="/posts/652176ee/">Containerd CVE-2020–15257细节说明</a></li>
<li><a href="/posts/1df3dc63/">OpenAI关于Kubernetes集群近万节点的生产实践</a></li>
<li><a href="/posts/5a8a6c8d/">一条K8s命令行引发的血案</a></li>
<li><a href="/posts/3f237e52/">揭开K8s适配CgroupV2内存虚高的迷局</a></li>
<li><a href="/posts/e46bd846/">探索Kubernetes 1.28调度器OOM的根源</a></li>
<li><a href="/posts/b421b57/">解读Kubernetes常见错误码</a></li>
<li><a href="/posts/186b05db/">RLIMIT_NOFILE设置陷阱：容器应用高频异常的隐形元凶</a></li>
</ol>
<h2 id="一条K8s命令行引发的血案"><a href="#一条K8s命令行引发的血案" class="headerlink" title="一条K8s命令行引发的血案"></a>一条K8s命令行引发的血案</h2><h2 id="问题描述"><a href="#问题描述" class="headerlink" title="问题描述"></a>问题描述</h2><p>因为Centos EOL的缘故，去年内部忙着换OS，打算趁此机会从cgroup v1切到cgroup v2，然而，在低版本K8s适配cgroupv2的过程中，遇到了一些问题，前期kubelet在cgroup v1的环境下，使用<code>-enable_load_reader</code>暴露容器的cpu load等相关监控数据，但在cgroup v2环境下，使用该配置会导致kubelet发生panic</p>
<p>下述为关键性信息：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">container.go:422] Could not initialize cpu load reader for &quot;/kubepods.slice/kubepods-besteffort.slice/kubepods-besteffort-podXXX.slice&quot;: failed to create a netlink based cpuload reader: failed to get netlink family id for task stats: binary.Read: invalid type int32</span><br></pre></td></tr></table></figure>

<h2 id="技术背景"><a href="#技术背景" class="headerlink" title="技术背景"></a>技术背景</h2><p>该章节介绍以下内容：</p>
<ul>
<li>容器指标如何生成</li>
<li>K8s如何集成容器监控</li>
<li>cpu load如何计算等</li>
</ul>
<h3 id="cadvisor"><a href="#cadvisor" class="headerlink" title="cadvisor"></a>cadvisor</h3><p>cAdvisor是一款强大的Docker容器监控工具，专为容器场景设计，方便监控资源使用和性能分析。它用于收集、汇总、处理和输出容器的相关信息。cAdvisor支持Docker容器，同时支持其他类型的容器运行时。</p>
<p>Kubelet内置了对cAdvisor的支持，用户可以直接通过Kubelet组件获取有关节点上容器的监控指标。</p>
<blockquote>
<p>K8s 1.19使用的cAdvisor版本为0.39.3，而这里的简要介绍使用的是版本0.48.1。</p>
</blockquote>
<p>以下是主要功能代码，其中包含了一些注释以提高可读性。代码路径为：&#x2F;cadvisor&#x2F;cmd&#x2F;cadvisor.go。</p>
<p>cAdvisor主要完成以下几项任务：</p>
<ul>
<li>对外提供外部使用的API，包括一般的API接口和Prometheus接口。</li>
<li>支持第三方数据存储，包括BigQuery、Elasticsearch、InfluxDB、Kafka、Prometheus、Redis、StatsD和标准输出。</li>
<li>收集与容器、进程、机器、Go运行时以及自定义业务相关的监控。</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">func init() &#123;</span><br><span class="line">	optstr := container.AllMetrics.String()</span><br><span class="line">	flag.Var(&amp;ignoreMetrics, &quot;disable_metrics&quot;, fmt.Sprintf(&quot;comma-separated list of `metrics` to be disabled. Options are %s.&quot;, optstr))</span><br><span class="line">	flag.Var(&amp;enableMetrics, &quot;enable_metrics&quot;, fmt.Sprintf(&quot;comma-separated list of `metrics` to be enabled. If set, overrides &#x27;disable_metrics&#x27;. Options are %s.&quot;, optstr))</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>从上述代码可以看到，cadvisor支持是否开启相关指标的能力，其中<code>AllMetrics</code>主要是下述指标:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">https://github.com/google/cadvisor/blob/master/container/factory.go#L72</span><br><span class="line"></span><br><span class="line">var AllMetrics = MetricSet&#123;</span><br><span class="line">	CpuUsageMetrics:                struct&#123;&#125;&#123;&#125;,</span><br><span class="line">	ProcessSchedulerMetrics:        struct&#123;&#125;&#123;&#125;,</span><br><span class="line">	PerCpuUsageMetrics:             struct&#123;&#125;&#123;&#125;,</span><br><span class="line">	MemoryUsageMetrics:             struct&#123;&#125;&#123;&#125;,</span><br><span class="line">	MemoryNumaMetrics:              struct&#123;&#125;&#123;&#125;,</span><br><span class="line">	CpuLoadMetrics:                 struct&#123;&#125;&#123;&#125;,</span><br><span class="line">	DiskIOMetrics:                  struct&#123;&#125;&#123;&#125;,</span><br><span class="line">	DiskUsageMetrics:               struct&#123;&#125;&#123;&#125;,</span><br><span class="line">	NetworkUsageMetrics:            struct&#123;&#125;&#123;&#125;,</span><br><span class="line">	NetworkTcpUsageMetrics:         struct&#123;&#125;&#123;&#125;,</span><br><span class="line">	NetworkAdvancedTcpUsageMetrics: struct&#123;&#125;&#123;&#125;,</span><br><span class="line">	NetworkUdpUsageMetrics:         struct&#123;&#125;&#123;&#125;,</span><br><span class="line">	ProcessMetrics:                 struct&#123;&#125;&#123;&#125;,</span><br><span class="line">	AppMetrics:                     struct&#123;&#125;&#123;&#125;,</span><br><span class="line">	HugetlbUsageMetrics:            struct&#123;&#125;&#123;&#125;,</span><br><span class="line">	PerfMetrics:                    struct&#123;&#125;&#123;&#125;,</span><br><span class="line">	ReferencedMemoryMetrics:        struct&#123;&#125;&#123;&#125;,</span><br><span class="line">	CPUTopologyMetrics:             struct&#123;&#125;&#123;&#125;,</span><br><span class="line">	ResctrlMetrics:                 struct&#123;&#125;&#123;&#125;,</span><br><span class="line">	CPUSetMetrics:                  struct&#123;&#125;&#123;&#125;,</span><br><span class="line">	OOMMetrics:                     struct&#123;&#125;&#123;&#125;,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line">func main() &#123;</span><br><span class="line">	...</span><br><span class="line"></span><br><span class="line">	var includedMetrics container.MetricSet</span><br><span class="line">	if len(enableMetrics) &gt; 0 &#123;</span><br><span class="line">		includedMetrics = enableMetrics</span><br><span class="line">	&#125; else &#123;</span><br><span class="line">		includedMetrics = container.AllMetrics.Difference(ignoreMetrics)</span><br><span class="line">	&#125;</span><br><span class="line">	// 上述处理需要开启的指标</span><br><span class="line">	klog.V(1).Infof(&quot;enabled metrics: %s&quot;, includedMetrics.String())</span><br><span class="line">	setMaxProcs()</span><br><span class="line">	// 内存方式存在监控指标</span><br><span class="line">	memoryStorage, err := NewMemoryStorage()</span><br><span class="line">	if err != nil &#123;</span><br><span class="line">		klog.Fatalf(&quot;Failed to initialize storage driver: %s&quot;, err)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	sysFs := sysfs.NewRealSysFs()</span><br><span class="line"></span><br><span class="line">	</span><br><span class="line">	// 这是cadvisor核心逻辑，kubelet内部就是直接调用的manager.New</span><br><span class="line">	resourceManager, err := manager.New(memoryStorage, sysFs, manager.HousekeepingConfigFlags, includedMetrics, &amp;collectorHTTPClient, strings.Split(*rawCgroupPrefixWhiteList, &quot;,&quot;), strings.Split(*envMetadataWhiteList, &quot;,&quot;), *perfEvents, *resctrlInterval)</span><br><span class="line">	if err != nil &#123;</span><br><span class="line">		klog.Fatalf(&quot;Failed to create a manager: %s&quot;, err)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">	// 注册对外的HTTP接口.</span><br><span class="line">	err = cadvisorhttp.RegisterHandlers(mux, resourceManager, *httpAuthFile, *httpAuthRealm, *httpDigestFile, *httpDigestRealm, *urlBasePrefix)</span><br><span class="line">	if err != nil &#123;</span><br><span class="line">		klog.Fatalf(&quot;Failed to register HTTP handlers: %v&quot;, err)</span><br><span class="line">	&#125;</span><br><span class="line">	// 这里是容器标签的处理，kubelet 1.28切换到CRI之后需要修改kubelet</span><br><span class="line">	containerLabelFunc := metrics.DefaultContainerLabels</span><br><span class="line">	if !*storeContainerLabels &#123;</span><br><span class="line">		whitelistedLabels := strings.Split(*whitelistedContainerLabels, &quot;,&quot;)</span><br><span class="line">		// Trim spacing in labels</span><br><span class="line">		for i := range whitelistedLabels &#123;</span><br><span class="line">			whitelistedLabels[i] = strings.TrimSpace(whitelistedLabels[i])</span><br><span class="line">		&#125;</span><br><span class="line">		containerLabelFunc = metrics.BaseContainerLabels(whitelistedLabels)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>其中cpu load是否生成指标，同时也由命令行<code>enable_load_reader</code>控制</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">https://github.com/google/cadvisor/blob/42bb3d13a0cf9ab80c880a16c4ebb4f36e51b0c9/manager/container.go#L455</span><br><span class="line"></span><br><span class="line">if *enableLoadReader &#123;</span><br><span class="line">		// Create cpu load reader.</span><br><span class="line">		loadReader, err := cpuload.New()</span><br><span class="line">		if err != nil &#123;</span><br><span class="line">			klog.Warningf(&quot;Could not initialize cpu load reader for %q: %s&quot;, ref.Name, err)</span><br><span class="line">		&#125; else &#123;</span><br><span class="line">			cont.loadReader = loadReader</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>



<h3 id="Kubelet"><a href="#Kubelet" class="headerlink" title="Kubelet"></a>Kubelet</h3><p>在Kubernetes中，Google的cAdvisor项目被用于节点上容器资源和性能指标的收集。在kubelet server中，cAdvisor被集成用于监控该节点上kubepods（默认cgroup名称，systemd模式下会加上.slice后缀） cgroup下的所有容器。从1.29.0-alpha.2版本中可以看到，kubelet目前还是提供了以下两种配置选项（但是现在useLegacyCadvisorStats为<strong>false</strong>）：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">if kubeDeps.useLegacyCadvisorStats &#123;</span><br><span class="line">    klet.StatsProvider = stats.NewCadvisorStatsProvider(</span><br><span class="line">      klet.cadvisor,</span><br><span class="line">      klet.resourceAnalyzer,</span><br><span class="line">      klet.podManager,</span><br><span class="line">      klet.runtimeCache,</span><br><span class="line">      klet.containerRuntime,</span><br><span class="line">      klet.statusManager,</span><br><span class="line">      hostStatsProvider)</span><br><span class="line">  &#125; else &#123;</span><br><span class="line">    klet.StatsProvider = stats.NewCRIStatsProvider(</span><br><span class="line">      klet.cadvisor,</span><br><span class="line">      klet.resourceAnalyzer,</span><br><span class="line">      klet.podManager,</span><br><span class="line">      klet.runtimeCache,</span><br><span class="line">      kubeDeps.RemoteRuntimeService,</span><br><span class="line">      kubeDeps.RemoteImageService,</span><br><span class="line">      hostStatsProvider,</span><br><span class="line">      utilfeature.DefaultFeatureGate.Enabled(features.PodAndContainerStatsFromCRI))</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>

<p>kubelet以Prometheus指标格式在&#x2F;stats&#x2F;暴露所有相关运行时指标，如下图所示，Kubelet内置了cadvisor服务</p>
<p><img src="https://pic.imgdb.cn/item/65b43ba0871b83018ac66a1f.png"></p>
<p>最终可以看到cadvisor组件如何在kubelet完成初始化</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">https://github.com/kubernetes/kubernetes/blob/master/pkg/kubelet/cadvisor/cadvisor_linux.go#L80</span><br><span class="line"></span><br><span class="line">func New(imageFsInfoProvider ImageFsInfoProvider, rootPath string, cgroupRoots []string, usingLegacyStats, localStorageCapacityIsolation bool) (Interface, error) &#123;</span><br><span class="line">	sysFs := sysfs.NewRealSysFs()</span><br><span class="line">	// 这里就是kubelet默认暴露的监控指标类型</span><br><span class="line">	includedMetrics := cadvisormetrics.MetricSet&#123;</span><br><span class="line">		...</span><br><span class="line">		cadvisormetrics.CpuLoadMetrics:      struct&#123;&#125;&#123;&#125;,</span><br><span class="line">		...</span><br><span class="line">	&#125;</span><br><span class="line">	// 创建cAdvisor container manager.</span><br><span class="line">	m, err := manager.New(memory.New(statsCacheDuration, nil), sysFs, housekeepingConfig, includedMetrics, http.DefaultClient, cgroupRoots, nil /* containerEnvMetadataWhiteList */, &quot;&quot; /* perfEventsFile */, time.Duration(0) /*resctrlInterval*/)</span><br><span class="line">	...</span><br></pre></td></tr></table></figure>

<p>这里就是直接调用的cadvisor的manager.New的函数接口，更详细的信息可参看：<a href="https://zoues.com/posts/3f237e52/">https://zoues.com/posts/3f237e52/</a></p>
<h3 id="CPU-Load指标"><a href="#CPU-Load指标" class="headerlink" title="CPU Load指标"></a>CPU Load指标</h3><p>CPU使用率反映的是当前cpu的繁忙程度，CPU平均负载（load average）是指某段时间内占用cpu时间的进程和等待cpu时间的进程数，这里等待cpu时间的进程是指等待被唤醒的进程，不包括处于wait状态进程。</p>
<p>在对设备做相关诊断时，需要结合cpu使用率、平均负载以及任务状态来进行判断，比如CPU使用率低但负载高，可能是IO瓶颈等，对此不作深入介绍。</p>
<p>在cadvisor中对外暴露的指标名称为</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">container_cpu_load_average_10s</span><br></pre></td></tr></table></figure>

<p>那么我们来看看是如何被计算出来的</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">https://github.com/google/cadvisor/blob/master/manager/container.go#L632</span><br><span class="line"></span><br><span class="line">// Calculate new smoothed load average using the new sample of runnable threads.</span><br><span class="line">// The decay used ensures that the load will stabilize on a new constant value within</span><br><span class="line">// 10 seconds.</span><br><span class="line">func (cd *containerData) updateLoad(newLoad uint64) &#123;</span><br><span class="line">	if cd.loadAvg &lt; 0 &#123;</span><br><span class="line">		cd.loadAvg = float64(newLoad) // initialize to the first seen sample for faster stabilization.</span><br><span class="line">	&#125; else &#123;</span><br><span class="line">		cd.loadAvg = cd.loadAvg*cd.loadDecay + float64(newLoad)*(1.0-cd.loadDecay)</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>公式计算：<code>cd.loadAvg = cd.loadAvg*cd.loadDecay + float64(newLoad)*(1.0-cd.loadDecay)</code></p>
<p>大体意思是取的上一次采集计算出来的值cd.loadAvg乘以计算因子cd.loadDecay，然后加上当前采集</p>
<p>到的newLoad值乘以(1.0-cd.loadDecay)最后得出当前的cd.loadAvg值</p>
<p>其中<code>cont.loadDecay</code>计算逻辑如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">https://github.com/google/cadvisor/blob/master/manager/container.go#L453</span><br><span class="line"></span><br><span class="line">cont.loadDecay = math.Exp(float64(-cont.housekeepingInterval.Seconds() / 10))</span><br></pre></td></tr></table></figure>

<p>这里是跟<code>housekeepingInterval</code>相关的固定值，衰变窗口</p>
<blockquote>
<p>关于容器cpu load的详细介绍可以看引用链接</p>
</blockquote>
<h2 id="寻根溯源"><a href="#寻根溯源" class="headerlink" title="寻根溯源"></a>寻根溯源</h2><p>cpu load的cd.loadAvg前值通过如下方式获取：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">https://github.com/google/cadvisor/blob/master/manager/container.go#L650</span><br><span class="line"></span><br><span class="line">if cd.loadReader != nil &#123;</span><br><span class="line">		// TODO(vmarmol): Cache this path.</span><br><span class="line">		path, err := cd.handler.GetCgroupPath(&quot;cpu&quot;)</span><br><span class="line">		if err == nil &#123;</span><br><span class="line">			loadStats, err := cd.loadReader.GetCpuLoad(cd.info.Name, path)</span><br><span class="line">			if err != nil &#123;</span><br><span class="line">				return fmt.Errorf(&quot;failed to get load stat for %q - path %q, error %s&quot;, cd.info.Name, path, err)</span><br><span class="line">			&#125;</span><br><span class="line">			stats.TaskStats = loadStats</span><br><span class="line">			cd.updateLoad(loadStats.NrRunning)</span><br><span class="line">			// convert to &#x27;milliLoad&#x27; to avoid floats and preserve precision.</span><br><span class="line">			stats.Cpu.LoadAverage = int32(cd.loadAvg * 1000)</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>

<p>深入探究可以发现使用了netlink来获取系统指标，关键调用路径:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">updateStats-&gt;GetCpuLoad-&gt;getLoadStats-&gt;prepareCmdMessage-&gt;prepareMessage</span><br></pre></td></tr></table></figure>



<p>经过上述分析可知， cAdvisor通过发送CGROUPSTATS_CMD_GET请求来获取CPU负载信息，通过netlink消息进行通信：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cadvisor/utils/cpuload/netlink/netlink.go</span><br></pre></td></tr></table></figure>

<p>在<code>v0.48.1</code>分支的第128到132行：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">func prepareCmdMessage(id uint16, cfd uintptr) (msg netlinkMessage) &#123; </span><br><span class="line">	buf := bytes.NewBuffer([]byte&#123;&#125;) </span><br><span class="line">	addAttribute(buf, unix.CGROUPSTATS_CMD_ATTR_FD, uint32(cfd), 4) </span><br><span class="line">	return prepareMessage(id, unix.CGROUPSTATS_CMD_GET, buf.Bytes()) </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>最终内核在<code>cgroupstats_user_cmd</code>中处理获取请求：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/* user-&gt;kernel request/get-response */</span><br></pre></td></tr></table></figure>

<p><a target="_blank" rel="noopener" href="https://github.com/torvalds/linux/blob/master/kernel/taskstats.c#L407"><code>kernel/taskstats.c#L407</code></a></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line">static int cgroupstats_user_cmd(struct sk_buff *skb, struct genl_info *info)</span><br><span class="line">&#123;</span><br><span class="line">	int rc = 0;</span><br><span class="line">	struct sk_buff *rep_skb;</span><br><span class="line">	struct cgroupstats *stats;</span><br><span class="line">	struct nlattr *na;</span><br><span class="line">	size_t size;</span><br><span class="line">	u32 fd;</span><br><span class="line">	struct fd f;</span><br><span class="line"></span><br><span class="line">	na = info-&gt;attrs[CGROUPSTATS_CMD_ATTR_FD];</span><br><span class="line">	if (!na)</span><br><span class="line">		return -EINVAL;</span><br><span class="line"></span><br><span class="line">	fd = nla_get_u32(info-&gt;attrs[CGROUPSTATS_CMD_ATTR_FD]);</span><br><span class="line">	f = fdget(fd);</span><br><span class="line">	if (!f.file)</span><br><span class="line">		return 0;</span><br><span class="line"></span><br><span class="line">	size = nla_total_size(sizeof(struct cgroupstats));</span><br><span class="line"></span><br><span class="line">	rc = prepare_reply(info, CGROUPSTATS_CMD_NEW, &amp;rep_skb,</span><br><span class="line">				size);</span><br><span class="line">	if (rc &lt; 0)</span><br><span class="line">		goto err;</span><br><span class="line"></span><br><span class="line">	na = nla_reserve(rep_skb, CGROUPSTATS_TYPE_CGROUP_STATS,</span><br><span class="line">				sizeof(struct cgroupstats));</span><br><span class="line">	if (na == NULL) &#123;</span><br><span class="line">		nlmsg_free(rep_skb);</span><br><span class="line">		rc = -EMSGSIZE;</span><br><span class="line">		goto err;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	stats = nla_data(na);</span><br><span class="line">	memset(stats, 0, sizeof(*stats));</span><br><span class="line"></span><br><span class="line">	rc = cgroupstats_build(stats, f.file-&gt;f_path.dentry);</span><br><span class="line">	if (rc &lt; 0) &#123;</span><br><span class="line">		nlmsg_free(rep_skb);</span><br><span class="line">		goto err;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	rc = send_reply(rep_skb, info);</span><br><span class="line"></span><br><span class="line">err:</span><br><span class="line">	fdput(f);</span><br><span class="line">	return rc;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>并在<code>cgroupstats_build</code>函数中构建cgroup stats结果：</p>
<p><a target="_blank" rel="noopener" href="https://github.com/torvalds/linux/blob/5c1ee569660d4a205dced9cb4d0306b907fb7599/kernel/cgroup/cgroup-v1.c#L699"><code>kernel/cgroup/cgroup-v1.c#L699</code></a></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line"> * cgroupstats_build - build and fill cgroupstats</span><br><span class="line"> * @stats: cgroupstats to fill information into</span><br><span class="line"> * @dentry: A dentry entry belonging to the cgroup for which stats have</span><br><span class="line"> * been requested.</span><br><span class="line"> *</span><br><span class="line"> * Build and fill cgroupstats so that taskstats can export it to user</span><br><span class="line"> * space.</span><br><span class="line"> *</span><br><span class="line"> * Return: %0 on success or a negative errno code on failure</span><br><span class="line"> */</span><br><span class="line">int cgroupstats_build(struct cgroupstats *stats, struct dentry *dentry)</span><br><span class="line">&#123;</span><br><span class="line">……</span><br><span class="line">	/* it should be kernfs_node belonging to cgroupfs and is a directory */</span><br><span class="line">	if (dentry-&gt;d_sb-&gt;s_type != &amp;cgroup_fs_type || !kn ||</span><br><span class="line">	    kernfs_type(kn) != KERNFS_DIR)</span><br><span class="line">		return -EINVAL;  // 导致返回EINVAL错误码</span><br></pre></td></tr></table></figure>

<p>这里可以发现<code>cgroup_fs_type</code>是cgroup v1的类型，而没有处理cgroup v2。因此，<code>cgroupstats_build</code>函数在路径类型判断语句上返回EINVAL。</p>
<p>在内核社区也有相关问题的说明：<a target="_blank" rel="noopener" href="https://lore.kernel.org/all/20200910055207.87702-1-zhouchengming@bytedance.com/T/#r50c826a171045e42d0b40a552e0d4d1b2a2bab4d">kernel community issue</a></p>
<p>那么我们看看tejun(meta，cgroupv2 owner)如何解释的：</p>
<blockquote>
<p>The exclusion of cgroupstats from v2 interface was intentional due to the duplication and inconsistencies with other statistics. If you need these numbers, please justify and add them to the appropriate cgroupfs stat file.</p>
</blockquote>
<p>简单翻译：对v2接口中排除cgroupstats的操作是有意的，因为它与其他统计数据存在重复和不一致之处。</p>
<h2 id="结论"><a href="#结论" class="headerlink" title="结论"></a>结论</h2><p>那么他的建议是什么？</p>
<p>他建议我们使用psi，而不是通过CGROUPSTATS_CMD_GET netlink api获取CPU统计信息，直接从<code>cpu.pressure</code>、<code>memory.pressure</code>以及<code>io.pressure</code>文件中获取，后续我们会介绍psi在容器领域的相关进展，当前Containerd已经支持PSI相关监控.</p>
<h2 id="参考链接"><a href="#参考链接" class="headerlink" title="参考链接"></a>参考链接</h2><ol>
<li><a target="_blank" rel="noopener" href="https://github.com/containerd/cgroups/pull/308">https://github.com/containerd/cgroups/pull/308</a></li>
<li><a target="_blank" rel="noopener" href="https://cloud.tencent.com/developer/article/2329489">https://cloud.tencent.com/developer/article/2329489</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/google/cadvisor/issues/3137">https://github.com/google/cadvisor/issues/3137</a></li>
<li><a target="_blank" rel="noopener" href="https://www.cnblogs.com/vinsent/p/15830271.html">https://www.cnblogs.com/vinsent/p/15830271.html</a></li>
<li><a target="_blank" rel="noopener" href="https://lore.kernel.org/all/20200910055207.87702-1-zhouchengming@bytedance.com/T/#r50c826a171045e42d0b40a552e0d4d1b2a2bab4d">https://lore.kernel.org/all/20200910055207.87702-1-zhouchengming@bytedance.com/T/#r50c826a171045e42d0b40a552e0d4d1b2a2bab4d</a></li>
</ol>

  </div>
</article>



        
          <div id="footer-post-container">
  <div id="footer-post">

    <div id="nav-footer" style="display: none">
      <ul>
        
          <li><a href="/">Home</a></li>
        
          <li><a href="/about/">About</a></li>
        
          <li><a href="/categories/">Category</a></li>
        
          <li><a href="/archives/">Writing</a></li>
        
          <li><a target="_blank" rel="noopener" href="http://github.com/zouyee">Projects</a></li>
        
      </ul>
    </div>

    
    
      <div id="toc-footer" style="display: none">
        <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%80%E6%9D%A1K8s%E5%91%BD%E4%BB%A4%E8%A1%8C%E5%BC%95%E5%8F%91%E7%9A%84%E8%A1%80%E6%A1%88"><span class="toc-number">1.</span> <span class="toc-text">一条K8s命令行引发的血案</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%97%AE%E9%A2%98%E6%8F%8F%E8%BF%B0"><span class="toc-number">2.</span> <span class="toc-text">问题描述</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%8A%80%E6%9C%AF%E8%83%8C%E6%99%AF"><span class="toc-number">3.</span> <span class="toc-text">技术背景</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#cadvisor"><span class="toc-number">3.1.</span> <span class="toc-text">cadvisor</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Kubelet"><span class="toc-number">3.2.</span> <span class="toc-text">Kubelet</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#CPU-Load%E6%8C%87%E6%A0%87"><span class="toc-number">3.3.</span> <span class="toc-text">CPU Load指标</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AF%BB%E6%A0%B9%E6%BA%AF%E6%BA%90"><span class="toc-number">4.</span> <span class="toc-text">寻根溯源</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%BB%93%E8%AE%BA"><span class="toc-number">5.</span> <span class="toc-text">结论</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8F%82%E8%80%83%E9%93%BE%E6%8E%A5"><span class="toc-number">6.</span> <span class="toc-text">参考链接</span></a></li></ol>
      </div>
    

    <div id="share-footer" style="display: none">
      <ul>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.facebook.com/sharer.php?u=https://zoues.com/posts/5a8a6c8d/"><i class="fab fa-facebook fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://twitter.com/share?url=https://zoues.com/posts/5a8a6c8d/&text=一条K8s命令行引发的血案"><i class="fab fa-twitter fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.linkedin.com/shareArticle?url=https://zoues.com/posts/5a8a6c8d/&title=一条K8s命令行引发的血案"><i class="fab fa-linkedin fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://pinterest.com/pin/create/bookmarklet/?url=https://zoues.com/posts/5a8a6c8d/&is_video=false&description=一条K8s命令行引发的血案"><i class="fab fa-pinterest fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=一条K8s命令行引发的血案&body=Check out this article: https://zoues.com/posts/5a8a6c8d/"><i class="fa-solid fa-envelope fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://getpocket.com/save?url=https://zoues.com/posts/5a8a6c8d/&title=一条K8s命令行引发的血案"><i class="fab fa-get-pocket fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://reddit.com/submit?url=https://zoues.com/posts/5a8a6c8d/&title=一条K8s命令行引发的血案"><i class="fab fa-reddit fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.stumbleupon.com/submit?url=https://zoues.com/posts/5a8a6c8d/&title=一条K8s命令行引发的血案"><i class="fab fa-stumbleupon fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://digg.com/submit?url=https://zoues.com/posts/5a8a6c8d/&title=一条K8s命令行引发的血案"><i class="fab fa-digg fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.tumblr.com/share/link?url=https://zoues.com/posts/5a8a6c8d/&name=一条K8s命令行引发的血案&description="><i class="fab fa-tumblr fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://news.ycombinator.com/submitlink?u=https://zoues.com/posts/5a8a6c8d/&t=一条K8s命令行引发的血案"><i class="fab fa-hacker-news fa-lg" aria-hidden="true"></i></a></li>
</ul>

    </div>

    <div id="actions-footer">
        <a id="menu" class="icon" href="#" onclick="$('#nav-footer').toggle();return false;"><i class="fa-solid fa-bars fa-lg" aria-hidden="true"></i> Menu</a>
        
          <a id="toc" class="icon" href="#" onclick="$('#toc-footer').toggle();return false;"><i class="fa-solid fa-list fa-lg" aria-hidden="true"></i> TOC</a>
        
        <a id="share" class="icon" href="#" onclick="$('#share-footer').toggle();return false;"><i class="fa-solid fa-share-alt fa-lg" aria-hidden="true"></i> Share</a>
        <a id="top" style="display:none" class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fa-solid fa-chevron-up fa-lg" aria-hidden="true"></i> Top</a>
    </div>

  </div>
</div>

        
        <footer id="footer">
  <div class="footer-left">
    Copyright &copy;
    
    
    2016-2024
    zouyee
  </div>
  <div class="footer-right">
    <nav>
      <ul>
        <!--
       --><li><a href="/">Home</a></li><!--
     --><!--
       --><li><a href="/about/">About</a></li><!--
     --><!--
       --><li><a href="/categories/">Category</a></li><!--
     --><!--
       --><li><a href="/archives/">Writing</a></li><!--
     --><!--
       --><li><a target="_blank" rel="noopener" href="http://github.com/zouyee">Projects</a></li><!--
     -->
      </ul>
    </nav>
  </div>
</footer>

    </div>
    <!-- styles -->



  <link rel="preload" as="style" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" crossorigin="anonymous" onload="this.onload=null;this.rel='stylesheet'"/>


    <!-- jquery -->

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js" crossorigin="anonymous"></script>




<!-- clipboard -->

  
    <script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.7/clipboard.min.js" crossorigin="anonymous"></script>
  
  <script type="text/javascript">
  $(function() {
    // copy-btn HTML
    var btn = "<span class=\"btn-copy tooltipped tooltipped-sw\" aria-label=\"Copy to clipboard!\">";
    btn += '<i class="fa-regular fa-clone"></i>';
    btn += '</span>';
    // mount it!
    $(".highlight table").before(btn);
    var clip = new ClipboardJS('.btn-copy', {
      text: function(trigger) {
        return Array.from(trigger.nextElementSibling.querySelectorAll('.code')).reduce((str,it)=>str+it.innerText+'\n','')
      }
    });
    clip.on('success', function(e) {
      e.trigger.setAttribute('aria-label', "Copied!");
      e.clearSelection();
    })
  })
  </script>


<script src="/js/main.js"></script>

<!-- search -->

<!-- Baidu Analytics -->

<!-- Cloudflare Analytics -->

<!-- Disqus Comments -->

<!-- utterances Comments -->

</body>
</html>
