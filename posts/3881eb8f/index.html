<!DOCTYPE html>
<html lang=en>
<head>
    <!-- so meta -->
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="HandheldFriendly" content="True">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=5" />
    <meta name="description" content="背景介绍Docker作为最早广泛应用的容器运行时，其普及程度使得用户对其操作方式和功能特性极为熟悉。在Kubernetes的初期，Kubernetes通过内置的dockershim组件与Docker进行适配。然而，随着容器技术的不断发展，Kubernetes推出了CRI（容器运行时接口）标准，以更好地规范和扩展容器的接入能力。这一创新不仅增强了Kubernetes对多种容器运行时的兼容性，也为用户">
<meta property="og:type" content="article">
<meta property="og:title" content="Dockerless：Containerd方案">
<meta property="og:url" content="https://zoues.com/posts/3881eb8f/index.html">
<meta property="og:site_name" content="zouyee">
<meta property="og:description" content="背景介绍Docker作为最早广泛应用的容器运行时，其普及程度使得用户对其操作方式和功能特性极为熟悉。在Kubernetes的初期，Kubernetes通过内置的dockershim组件与Docker进行适配。然而，随着容器技术的不断发展，Kubernetes推出了CRI（容器运行时接口）标准，以更好地规范和扩展容器的接入能力。这一创新不仅增强了Kubernetes对多种容器运行时的兼容性，也为用户">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://pic.imgdb.cn/item/673aba1fd29ded1a8c40c4fb.jpg">
<meta property="og:image" content="https://pic.imgdb.cn/item/673ab8f0d29ded1a8c3fc841.webp">
<meta property="og:image" content="https://pic.imgdb.cn/item/673ab904d29ded1a8c3fdb48.webp">
<meta property="og:image" content="https://pic.imgdb.cn/item/673ab91fd29ded1a8c3ff970.png">
<meta property="og:image" content="https://pic.imgdb.cn/item/673ab932d29ded1a8c400bfe.png">
<meta property="article:published_time" content="2024-11-18T12:23:48.000Z">
<meta property="article:modified_time" content="2024-11-18T04:29:54.824Z">
<meta property="article:author" content="zouyee">
<meta property="article:tag" content="Containerd">
<meta property="article:tag" content="runtime">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://pic.imgdb.cn/item/673aba1fd29ded1a8c40c4fb.jpg">
    
    
      
        
          <link rel="shortcut icon" href="/images/favicon.ico">
        
      
      
        
          <link rel="icon" type="image/png" href="/images/favicon-192x192.png" sizes="192x192">
        
      
      
        
          <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">
        
      
    
    <!-- title -->
    <title>Dockerless：Containerd方案</title>
    <!-- async scripts -->
    <!-- Google Analytics -->


    <!-- Umami Analytics -->


    <!-- styles -->
    
<link rel="stylesheet" href="/css/style.css">

    <!-- persian styles -->
    
    <!-- rss -->
    
    
      <link rel="alternate" href="/true" title="zouyee" type="application/atom+xml" />
    
	<!-- mathjax -->
	
<meta name="generator" content="Hexo 7.1.1"></head>

<body class="max-width mx-auto px3 ltr">
    
      <div id="header-post">
  <a id="menu-icon" href="#" aria-label="Menu"><i class="fa-solid fa-bars fa-lg"></i></a>
  <a id="menu-icon-tablet" href="#" aria-label="Menu"><i class="fa-solid fa-bars fa-lg"></i></a>
  <a id="top-icon-tablet" href="#" aria-label="Top" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');" style="display:none;"><i class="fa-solid fa-chevron-up fa-lg"></i></a>
  <span id="menu">
    <span id="nav">
      <ul>
        <!--
       --><li><a href="/">Home</a></li><!--
     --><!--
       --><li><a href="/about/">About</a></li><!--
     --><!--
       --><li><a href="/categories/">Category</a></li><!--
     --><!--
       --><li><a href="/archives/">Writing</a></li><!--
     --><!--
       --><li><a target="_blank" rel="noopener" href="http://github.com/zouyee">Projects</a></li><!--
     -->
      </ul>
    </span>
    <br/>
    <span id="actions">
      <ul>
        
        
        <li><a class="icon" aria-label="Next post" href="/posts/ae025efe/"><i class="fa-solid fa-chevron-right" aria-hidden="true" onmouseover="$('#i-next').toggle();" onmouseout="$('#i-next').toggle();"></i></a></li>
        
        <li><a class="icon" aria-label="Back to top" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fa-solid fa-chevron-up" aria-hidden="true" onmouseover="$('#i-top').toggle();" onmouseout="$('#i-top').toggle();"></i></a></li>
        <li><a class="icon" aria-label="Share post" href="#"><i class="fa-solid fa-share-alt" aria-hidden="true" onmouseover="$('#i-share').toggle();" onmouseout="$('#i-share').toggle();" onclick="$('#share').toggle();return false;"></i></a></li>
      </ul>
      <span id="i-prev" class="info" style="display:none;">Previous post</span>
      <span id="i-next" class="info" style="display:none;">Next post</span>
      <span id="i-top" class="info" style="display:none;">Back to top</span>
      <span id="i-share" class="info" style="display:none;">Share post</span>
    </span>
    <br/>
    <div id="share" style="display: none">
      <ul>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.facebook.com/sharer.php?u=https://zoues.com/posts/3881eb8f/"><i class="fab fa-facebook " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://twitter.com/share?url=https://zoues.com/posts/3881eb8f/&text=Dockerless：Containerd方案"><i class="fab fa-twitter " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.linkedin.com/shareArticle?url=https://zoues.com/posts/3881eb8f/&title=Dockerless：Containerd方案"><i class="fab fa-linkedin " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://pinterest.com/pin/create/bookmarklet/?url=https://zoues.com/posts/3881eb8f/&is_video=false&description=Dockerless：Containerd方案"><i class="fab fa-pinterest " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=Dockerless：Containerd方案&body=Check out this article: https://zoues.com/posts/3881eb8f/"><i class="fa-solid fa-envelope " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://getpocket.com/save?url=https://zoues.com/posts/3881eb8f/&title=Dockerless：Containerd方案"><i class="fab fa-get-pocket " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://reddit.com/submit?url=https://zoues.com/posts/3881eb8f/&title=Dockerless：Containerd方案"><i class="fab fa-reddit " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.stumbleupon.com/submit?url=https://zoues.com/posts/3881eb8f/&title=Dockerless：Containerd方案"><i class="fab fa-stumbleupon " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://digg.com/submit?url=https://zoues.com/posts/3881eb8f/&title=Dockerless：Containerd方案"><i class="fab fa-digg " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.tumblr.com/share/link?url=https://zoues.com/posts/3881eb8f/&name=Dockerless：Containerd方案&description="><i class="fab fa-tumblr " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://news.ycombinator.com/submitlink?u=https://zoues.com/posts/3881eb8f/&t=Dockerless：Containerd方案"><i class="fab fa-hacker-news " aria-hidden="true"></i></a></li>
</ul>

    </div>
    
    
      <div id="toc">
        <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%83%8C%E6%99%AF%E4%BB%8B%E7%BB%8D"><span class="toc-number">1.</span> <span class="toc-text">背景介绍</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%8A%80%E6%9C%AF%E8%83%8C%E6%99%AF"><span class="toc-number">2.</span> <span class="toc-text">技术背景</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#OCI-%E6%A0%87%E5%87%86-%EF%BC%88Open-Container-Initiative%EF%BC%89"><span class="toc-number">2.1.</span> <span class="toc-text">OCI 标准 （Open Container Initiative）</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Containerd"><span class="toc-number">2.2.</span> <span class="toc-text">Containerd</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#CRI"><span class="toc-number">2.3.</span> <span class="toc-text">CRI</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%91%BD%E4%BB%A4%E8%A1%8C%E7%9B%98%E7%82%B9"><span class="toc-number">3.</span> <span class="toc-text">命令行盘点</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#nerdctl"><span class="toc-number">3.1.</span> <span class="toc-text">nerdctl</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Containerd%E4%BD%BF%E7%94%A8%E6%8C%87%E5%8D%97"><span class="toc-number">4.</span> <span class="toc-text">Containerd使用指南</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-%E5%AE%89%E8%A3%85"><span class="toc-number">4.1.</span> <span class="toc-text">1. 安装</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-%E5%91%BD%E4%BB%A4%E7%AE%80%E4%BB%8B"><span class="toc-number">4.2.</span> <span class="toc-text">2. 命令简介</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%AE%B9%E5%99%A8%E7%AE%A1%E7%90%86"><span class="toc-number">4.2.1.</span> <span class="toc-text">容器管理</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%95%9C%E5%83%8F%E7%AE%A1%E7%90%86"><span class="toc-number">4.2.2.</span> <span class="toc-text">镜像管理</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#compose"><span class="toc-number">4.2.3.</span> <span class="toc-text">compose</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#CRICTL%E4%BD%BF%E7%94%A8%E6%8C%87%E5%8D%97"><span class="toc-number">5.</span> <span class="toc-text">CRICTL使用指南</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-%E5%AE%89%E8%A3%85-1"><span class="toc-number">5.1.</span> <span class="toc-text">1. 安装</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-%E5%91%BD%E4%BB%A4%E7%AE%80%E4%BB%8B-1"><span class="toc-number">5.2.</span> <span class="toc-text">2. 命令简介</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%93%BE%E6%8E%A5"><span class="toc-number">6.</span> <span class="toc-text">链接</span></a></li></ol>
      </div>
    
  </span>
</div>

    
    <div class="content index py4 ">
        
        <article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">
  <header>
    
    <h1 class="posttitle p-name" itemprop="name headline">
        Dockerless：Containerd方案
    </h1>



    <div class="meta">
      <span class="author p-author h-card" itemprop="author" itemscope itemtype="http://schema.org/Person">
        <span class="p-name" itemprop="name">zouyee</span>
      </span>
      
    <div class="postdate">
      
        <time datetime="2024-11-18T12:23:48.000Z" class="dt-published" itemprop="datePublished">2024-11-18</time>
        
      
    </div>


      

      
    <div class="article-tag">
        <i class="fa-solid fa-tag"></i>
        <a class="p-category" href="/tags/Containerd/" rel="tag">Containerd</a>, <a class="p-category" href="/tags/runtime/" rel="tag">runtime</a>
    </div>


    </div>
  </header>
  

  <div class="content e-content" itemprop="articleBody">
    <h2 id="背景介绍"><a href="#背景介绍" class="headerlink" title="背景介绍"></a>背景介绍</h2><p>Docker作为最早广泛应用的容器运行时，其普及程度使得用户对其操作方式和功能特性极为熟悉。在Kubernetes的初期，Kubernetes通过内置的dockershim组件与Docker进行适配。然而，随着容器技术的不断发展，Kubernetes推出了CRI（容器运行时接口）标准，以更好地规范和扩展容器的接入能力。这一创新不仅增强了Kubernetes对多种容器运行时的兼容性，也为用户提供了更多选择，提升了灵活性。</p>
<p>CRI的引入使Kubernetes的系统组件能够与各种容器运行时无缝交互。这一转变不仅扩展了Kubernetes的适用范围，使其不再局限于Docker，也降低了对Docker和dockershim的依赖。如今，Kubernetes用户可以放心选择如Containerd、CRI-O等优秀的容器运行时。这种转变简化了Kubernetes项目的架构，并提升了服务运行效率。</p>
<p>自Kubernetes 1.24版本起，官方已正式移除了对Docker（通过dockershim实现的CRI支持）的支持。同时，Amazon EKS也明确将Containerd作为其唯一的容器运行时。因此，我们也将集群的容器运行时切换至Containerd，并用nerdctl替换docker命令行。</p>
<p>在此，有必要介绍一些常见的容器组件，如<code>libcontainer</code>、<code>runc</code>、<code>containerd</code>、<code>CRI</code>、<code>OCI</code>等。这些组件在容器生态系统中扮演着关键角色，各自发挥独特功能，共同构建了一个高效、灵活的容器运行环境。通过深入了解这些组件，我们将更好地掌握容器技术的运维手段，为未来的应用部署与运维奠定坚实基础。如果想直接了解nerdctl的相关内容，请跳转至相应章节。</p>
<p>从Docker 1.11版本开始，Docker的容器运行除了Docker Daemon，还依赖于多个组件的协作，如containerd、runc等。虽然Docker Daemon守护进程模块不断重构，但其基本功能和定位未发生太大变化，依然保持CS架构，由守护进程负责与Docker Client交互，并管理Docker镜像和容器。</p>
<p>为了应对Docker引擎的复杂性问题，Docker项目将引擎中的部分核心功能抽象出来并开源，这便是Containerd项目的诞生。Containerd专注于容器的基本操作，如镜像管理、容器运行时和生命周期管理等，为容器管理工具提供了统一的接口。</p>
<p>在现代架构中，Containerd负责集群节点上容器的生命周期管理，并通过gRPC接口为Docker Daemon提供支持。</p>
<p><img src="https://pic.imgdb.cn/item/673aba1fd29ded1a8c40c4fb.jpg" alt="img"></p>
<h2 id="技术背景"><a href="#技术背景" class="headerlink" title="技术背景"></a>技术背景</h2><h3 id="OCI-标准-（Open-Container-Initiative）"><a href="#OCI-标准-（Open-Container-Initiative）" class="headerlink" title="OCI 标准 （Open Container Initiative）"></a>OCI 标准 （Open Container Initiative）</h3><p>OCI是由 Docker、CoreOS（被RedHat收购） 等组织对容器格式及运行时建立的统一的行业标准。</p>
<p>OCI主要定义两个规范：</p>
<ul>
<li>镜像规范（image-spec）定义了镜像的主要格式及内容</li>
<li>运行时规范（runtime-spec） 运行时规范定义镜像文件运行的管理， 而 runC 则是 目前使用最广泛的Low-Level容器运行时（runC 包含libcontainer，包括对namespace和cgroup的调用操作）。</li>
</ul>
<p>接下去看下目前市面上最主流的3个High-Level容器运行时（High-Level包括镜像传输、镜像管理、镜像解包和 API等高级功能）</p>
<ul>
<li>Containerd :CNCF孵化器的开源项目，由 Docker捐献的</li>
<li>Podman():Redhat孵化的项目，Podman 工具在RHEL8中作为完全支持的功能发布。</li>
<li>CRI-O : CNCF孵化器的开源项目</li>
</ul>
<p>我们再继续看一下 容器运行关系：</p>
<p><img src="https://pic.imgdb.cn/item/673ab8f0d29ded1a8c3fc841.webp" alt="ocs"></p>
<p>基于Containerd作为容器运行时的Docker可以定义为”High-High-Level”容器运行时。</p>
<p>关于 containerd 和 CRI 的关系要注意一些时间点:</p>
<ul>
<li>Containerd 在 2016年初被拆出来</li>
<li>CRI 标准在2016 年末出来的 （早于 Containerd）</li>
<li>Containerd 在2017年3月进入CNCF之后才添加了CRI支持.</li>
</ul>
<h3 id="Containerd"><a href="#Containerd" class="headerlink" title="Containerd"></a>Containerd</h3><p>Containerd 项目在 2017 年 3 月加入了云原生计算基金会（CNCF），其是一种简单、健壮和可移植性的行业标准容器运行时。它可作为 Linux 和 Windows 的守护进程，可以管理完整容器生命周期，包括镜像传输和存储、容器管理、底层存储和网络管理（通过CNI等）等功能。</p>
<p><img src="https://pic.imgdb.cn/item/673ab904d29ded1a8c3fdb48.webp" alt="containerd"></p>
<p>上图展示了 Containerd 的主要组件：</p>
<ol>
<li>Runtime：Containerd 负责容器的生命周期管理，包括容器的创建、运行和事件管理等。</li>
<li>Storage：Containerd 提供镜像存储管理。它负责容器镜像的存储、检索和管理。</li>
<li>gRPC：Containerd 使用 gRPC 服务器来与上层应用程序通信，为上层提供容器管理服务的接口。gRPC 是一种远程过程调用协议，使容器管理操作可以通过网络进行。</li>
<li>Metrics：Containerd 提供了有关容器性能和资源使用的指标，主要涉及 cgroup（控制组）的性能指标。</li>
<li>Metadata：容器的元数据，如镜像和容器的信息，以及与其相关的元数据，存储在 bootfs 中。这些元数据用于容器的管理和操作。</li>
<li>Tasks：在 Containerd 中，容器结构被管理为任务（tasks）。这包括容器的运行状态、进程信息和其他相关数据。</li>
<li>Events：Containerd 生成事件以通知上层应用程序容器的状态变化。这使上层应用程序能够订阅这些事件，以获知容器的状态变化，以及采取相应的操作。</li>
</ol>
<p>Containerd 项目在 2017 年 3 月加入了云原生计算基金会（CNCF），下图是Docker跟Containerd的对照表。</p>
<table>
<thead>
<tr>
<th><strong>特性</strong></th>
<th><strong>Containerd</strong></th>
<th><strong>Docker</strong></th>
</tr>
</thead>
<tbody><tr>
<td><strong>架构</strong></td>
<td>专注于容器运行时，负责容器生命周期的管理。</td>
<td>提供完整的容器平台，包含运行时和高级管理工具。</td>
</tr>
<tr>
<td><strong>镜像管理</strong></td>
<td>提供基础的镜像传输和存储功能。</td>
<td>提供高级镜像构建、版本控制和分发功能。</td>
</tr>
<tr>
<td><strong>生态系统</strong></td>
<td>模块化设计，常作为容器生态系统的一部分。</td>
<td>整合多种工具和服务，构建全面的容器生态系统。</td>
</tr>
<tr>
<td><strong>安全性</strong></td>
<td>针对核心功能进行小型优化和改进。</td>
<td>提供高级安全功能，如镜像签名和密钥管理。</td>
</tr>
<tr>
<td><strong>可扩展性</strong></td>
<td>提供精简机制，支持多种容器运行时场景。</td>
<td>提供插件机制，允许高度自定义和扩展。</td>
</tr>
<tr>
<td><strong>部署模式</strong></td>
<td>需要额外工具，如 Kubernetes，提供集成容器解决方案。</td>
<td>提供一体化容器部署管理，支持简单快速启动。</td>
</tr>
<tr>
<td><strong>社区支持</strong></td>
<td>获得 CNCF 和云原生基金会的支持。</td>
<td>社区由 Docker 公司主导，资源丰富。</td>
</tr>
<tr>
<td><strong>用户案例</strong></td>
<td>常用于构建自定义容器解决方案，如 Kubernetes。</td>
<td>适合构建容器化应用和分布式容器管理。</td>
</tr>
</tbody></table>
<h3 id="CRI"><a href="#CRI" class="headerlink" title="CRI"></a>CRI</h3><p>Kubernetes 提供了一个名为 CRI 的容器运行时接口。那么，CRI 到底是什么呢？这其实与 Docker 的发展有着密切关系。</p>
<p>在 Kubernetes 的早期阶段，Docker 因其广泛的流行，成为了 Kubernetes 首选支持的容器运行时。Kubernetes 当时通过硬编码的方式直接调用 Docker API。然而，随着 Docker 的不断演进以及 Google 的主导，更多的容器运行时开始涌现。为了支持这些更精简、更灵活的容器运行时，Google 联合红帽推出了 CRI（容器运行时接口）标准，以将 Kubernetes 平台与特定的容器运行时解耦（其中一个目的也是为了减少对 Docker 的依赖）。</p>
<p>CRI（Container Runtime Interface）本质上是一组 Kubernetes 定义的接口，用于与容器运行时进行交互。因此，任何实现了这套接口的容器运行时都可以无缝对接到 Kubernetes。然而，Kubernetes 推出 CRI 标准时，还没有如今的主导地位，因此一些容器运行时并未直接实现 CRI 接口。为了适配这些容器运行时，便引入了 <code>shim</code>。<code>shim</code> 作为适配器，将各种容器运行时的接口转换为 Kubernetes 可识别的 CRI 接口。其中，<code>dockershim</code> 就是 Kubernetes 为了对接 Docker 而实现的 CRI 适配器。</p>
<p><img src="https://pic.imgdb.cn/item/673ab91fd29ded1a8c3ff970.png" alt="dockershim"></p>
<p>Kubelet 通过 gRPC 与容器运行时或 shim 进行通信，其中 kubelet 作为客户端，CRI shim（或容器运行时本身）作为服务端。</p>
<p>CRI 定义的 <a target="_blank" rel="noopener" href="https://github.com/kubernetes/cri-api/tree/master/pkg/apis">API</a> 主要包括两个 gRPC 服务：<code>ImageService</code> 和 <code>RuntimeService</code>。<code>ImageService</code> 负责处理镜像的操作，如拉取、查看和删除镜像；而 <code>RuntimeService</code> 主要管理 Pod 和容器的生命周期，以及与容器交互的操作（如 exec、attach、port-forward）。可以通过 kubelet 的 <code>--container-runtime-endpoint</code> 和 <code>--image-service-endpoint</code> 命令行或者Kubelet配置文件来配置这两个服务的服务地址。</p>
<p>由于 Docker 当时处于主导地位，Kubernetes 直接将 <code>dockershim</code> 内置于 kubelet 中。因此，如果使用 Docker 作为容器运行时，无需额外安装或配置适配器。不过，这种内置支持也在一定程度上让 Docker 公司忽视了后续发展。</p>
<p>当使用 Docker 时，在 Kubernetes 中创建一个 Pod 的过程大致如下：首先，kubelet 通过 CRI 接口调用 <code>dockershim</code>，请求创建容器。此时，kubelet 作为CRI 客户端，而 <code>dockershim</code> 是接收请求的服务端代理，二者都内置于 kubelet 中。</p>
<p><code>dockershim</code> 收到请求后，会将其转换为 Docker Daemon 能识别的请求，发送给 Docker Daemon，请求创建容器。接下来，Docker Daemon 调用 <code>Containerd</code>，再由 <code>containerd</code> 创建 <code>containerd-shim</code> 进程（Containerd后续版本移除了containerd-shim），通过该进程调用 <code>runc</code> 来实际创建容器。</p>
<p>可以看出，使用 Docker 的调用链较长，而真正与容器相关的操作，<code>Containerd</code> 已经足够。尽管其深受欢迎的一个重要原因是为用户提供了许多友好的功能，但Docker实在是过于复杂和笨重，一些功能对于 Kubernetes 来说并不必要。因此，将容器运行时切换到 <code>Containerd</code> 是一个更为高效的选择。下图展示了插件的发展历程。</p>
<p><img src="https://pic.imgdb.cn/item/673ab932d29ded1a8c400bfe.png" alt="cri"></p>
<p>从上图可以看出，在 Containerd 1.0 中，CRI 的适配是通过一个独立的 <code>CRI-Containerd</code> 进程完成的。这是因为最初的 Containerd 还需要适配其他系统（如 Swarm），所以并未直接实现 CRI，而是由 <code>CRI-Containerd</code> 这个 shim 来承担。</p>
<p>到了 Containerd 1.1 版本，<code>CRI-Containerd</code> shim 被移除，适配逻辑被作为插件直接集成到 Containerd 主进程中，这使得调用流程更加简洁高效。</p>
<p>随着 CRI 方案的成熟以及其他容器运行时对 CRI 支持的不断完善，Kubernetes 社区在2020年7月启动了移除 dockershim 的计划。在 Kubernetes 1.20 版本中，kubelet 中内置的 dockershim 代码被分离，并将其标记为“维护模式”。尽管此时仍然可以使用 dockershim，但已经在 1.24 版本中彻底移除它，dockershim由</p>
<blockquote>
<p> 同时社区也提供相应的命令行工具crictl来与CRI进行交互</p>
</blockquote>
<h2 id="命令行盘点"><a href="#命令行盘点" class="headerlink" title="命令行盘点"></a>命令行盘点</h2><p>其中Docker、ctr、nerdctl 和 crictl 都是容器管理工具，但它们各自的设计目标和使用场景有所不同。以下是它们的对比：</p>
<p><strong>Docker</strong></p>
<ul>
<li><strong>简介</strong>：Docker 是一个流行的容器管理工具，提供了从构建、运行到管理容器的完整生态系统。</li>
<li><strong>功能</strong>：支持容器镜像构建、镜像分发（Docker Hub 集成）、容器生命周期管理（启动、停止、删除等）。</li>
<li><strong>接口</strong>：提供强大且用户友好的 CLI 和 API 接口，适合开发人员和运维人员快速上手。</li>
<li><strong>特点</strong>：<ul>
<li>有丰富的生态系统（如 Docker Compose）。</li>
<li>支持复杂的容器编排功能（如 Swarm）。</li>
<li>包含额外的守护进程（<code>dockerd</code>），需要与容器运行时协作。</li>
</ul>
</li>
</ul>
<p><strong>ctr</strong></p>
<ul>
<li><strong>简介</strong>：<code>ctr</code> 是 containerd 提供的原生 CLI，用于直接与 containerd 交互。</li>
<li><strong>功能</strong>：<code>ctr</code> 可以拉取镜像、运行容器、管理容器和镜像存储等基本功能，但功能相对简化，更适合低级操作和调试。</li>
<li><strong>接口</strong>：与 Docker 不同，<code>ctr</code> 面向 containerd 用户，没有像 Docker 那样的高级 API 和生态支持。</li>
<li><strong>特点</strong>：<ul>
<li>适合需要直接操作 containerd 的开发者和系统集成商。</li>
<li>不支持镜像构建等高级功能（containerd 专注于容器运行时管理）。</li>
</ul>
</li>
</ul>
<h3 id="nerdctl"><a href="#nerdctl" class="headerlink" title="nerdctl"></a><strong>nerdctl</strong></h3><ul>
<li><strong>简介</strong>：<code>nerdctl</code> 是一个基于 containerd 的命令行工具，支持 Docker 风格的 CLI 命令。</li>
<li><strong>功能</strong>：提供 Docker 类似的用户体验，可以直接用来运行容器、构建镜像、支持 CNI 网络插件和卷等。</li>
<li><strong>接口</strong>：与 Docker 的 CLI 非常相似，使得从 Docker 迁移到 nerdctl 相对简单。</li>
<li><strong>特点</strong>：<ul>
<li>不需要 Docker 守护进程，仅依赖 containerd。</li>
<li>可以与 Kubernetes（使用 containerd 作为运行时）很好地集成，且支持与 nerdctl 的 Docker Compose 类似功能。</li>
</ul>
</li>
</ul>
<p><strong>crictl</strong></p>
<ul>
<li><strong>简介</strong>：<code>crictl</code> 是一个用于容器运行时接口（CRI）的命令行工具，专为 Kubernetes 容器管理设计。</li>
<li><strong>功能</strong>：主要用于与 CRI 兼容的容器运行时（如 containerd 和 CRI-O）进行交互，包括管理 Pod、镜像和容器。</li>
<li><strong>接口</strong>：<code>crictl</code> 的命令集更偏向 Kubernetes 集群的调试和管理，与 Docker 和 nerdctl 相比，更专注于 Kubernetes 场景。</li>
<li><strong>特点</strong>：<ul>
<li>集成和兼容 Kubernetes，通常用来调试或管理容器和 Pod 运行状态。</li>
<li>不能用来构建镜像，专注于容器和 Pod 的生命周期管理。</li>
</ul>
</li>
</ul>
<p>前面我们了解了可以使用 docker、ctr、crictl 这些命令行工具进行容器管理，接下来我们针对以下几个场景做横向对比：</p>
<ol>
<li><strong>镜像相关操作</strong></li>
</ol>
<table>
<thead>
<tr>
<th><strong>镜像相关功能</strong></th>
<th><strong>docker CLI</strong></th>
<th>*<em>containerd ctr</em></th>
<th><strong>crictl</strong></th>
<th><strong>nerdctl</strong></th>
</tr>
</thead>
<tbody><tr>
<td>显示本地镜像列表</td>
<td><code>docker images</code></td>
<td><code>ctr i ls</code></td>
<td><code>crictl images</code></td>
<td><code>nerdctl images</code></td>
</tr>
<tr>
<td>下载镜像</td>
<td><code>docker pull</code></td>
<td><code>ctr i pull</code></td>
<td><code>crictl pull</code></td>
<td><code>nerdctl pull</code></td>
</tr>
<tr>
<td>上传镜像</td>
<td><code>docker push</code></td>
<td><code>ctr i push</code></td>
<td>无</td>
<td><code>nerdctl push</code></td>
</tr>
<tr>
<td>删除本地镜像</td>
<td><code>docker rmi</code></td>
<td><code>ctr i rm</code></td>
<td><code>crictl rmi</code></td>
<td><code>nerdctl rmi</code></td>
</tr>
<tr>
<td>查看镜像详情</td>
<td><code>docker inspect</code></td>
<td>无</td>
<td><code>crictl inspecti</code></td>
<td><code>nerdctl inspect</code></td>
</tr>
<tr>
<td>重命名镜像</td>
<td><code>docker tag</code></td>
<td><code>ctr i tag</code></td>
<td>无</td>
<td><code>nerdctl tag</code></td>
</tr>
<tr>
<td>导出镜像</td>
<td><code>docker export</code></td>
<td><code>ctr i export</code></td>
<td>无</td>
<td><code>nerdctl save</code></td>
</tr>
<tr>
<td>导入镜像</td>
<td><code>docker import</code></td>
<td><code>ctr i import</code></td>
<td>无</td>
<td><code>nerdctl load</code></td>
</tr>
<tr>
<td>构建镜像</td>
<td><code>docker build</code></td>
<td>无</td>
<td>无</td>
<td><code>nerdctl build</code></td>
</tr>
</tbody></table>
<ol start="2">
<li><strong>容器相关操作</strong></li>
</ol>
<table>
<thead>
<tr>
<th><strong>容器相关功能</strong></th>
<th><strong>docker CLI</strong></th>
<th><strong>containerd ctr</strong></th>
<th><strong>crictl</strong></th>
<th><strong>nerdctl</strong></th>
</tr>
</thead>
<tbody><tr>
<td>显示容器列表</td>
<td><code>docker ps</code></td>
<td><code>ctr c ls</code></td>
<td><code>crictl ps</code></td>
<td><code>nerdctl ps</code></td>
</tr>
<tr>
<td>创建容器</td>
<td><code>docker create</code></td>
<td><code>ctr c create</code></td>
<td><code>crictl create</code></td>
<td><code>nerdctl create</code></td>
</tr>
<tr>
<td>启动容器</td>
<td><code>docker start</code></td>
<td><code>ctr t start</code></td>
<td><code>crictl start</code></td>
<td><code>nerdctl start</code></td>
</tr>
<tr>
<td>停止容器</td>
<td><code>docker stop</code></td>
<td>无</td>
<td><code>crictl stop</code></td>
<td><code>nerdctl stop</code></td>
</tr>
<tr>
<td>删除容器</td>
<td><code>docker rm</code></td>
<td><code>ctr c rm</code></td>
<td><code>crictl rm</code></td>
<td><code>nerdctl rm</code></td>
</tr>
<tr>
<td>查看容器详情</td>
<td><code>docker inspect</code></td>
<td><code>ctr c info</code></td>
<td><code>crictl inspect</code></td>
<td><code>nerdctl inspect</code></td>
</tr>
<tr>
<td>attach</td>
<td><code>docker attach</code></td>
<td><code>ctr t attach</code></td>
<td><code>crictl attach</code></td>
<td><code>nerdctl attach</code></td>
</tr>
<tr>
<td>exec</td>
<td><code>docker exec</code></td>
<td><code>ctr t exec</code></td>
<td><code>crictl exec</code></td>
<td><code>nerdctl exec</code></td>
</tr>
<tr>
<td>logs</td>
<td><code>docker logs</code></td>
<td>无</td>
<td><code>crictl logs</code></td>
<td><code>nerdctl logs</code></td>
</tr>
<tr>
<td>stats</td>
<td><code>docker stats</code></td>
<td><code>ctr t metrics</code></td>
<td><code>crictl stats</code></td>
<td><code>nerdctl stats</code></td>
</tr>
</tbody></table>
<ol start="3">
<li><strong>Pod 相关操作</strong></li>
</ol>
<table>
<thead>
<tr>
<th><strong>Pod相关功能</strong></th>
<th><strong>docker CLI</strong></th>
<th><strong>containerd ctr</strong></th>
<th><strong>crictl</strong></th>
<th><strong>nerdctl</strong></th>
</tr>
</thead>
<tbody><tr>
<td>显示Pod列表</td>
<td>无</td>
<td>无</td>
<td><code>crictl pods</code></td>
<td>无</td>
</tr>
<tr>
<td>查看Pod详情</td>
<td>无</td>
<td>无</td>
<td><code>crictl inspectp</code></td>
<td>无</td>
</tr>
<tr>
<td>运行Pod</td>
<td>无</td>
<td>无</td>
<td><code>crictl runp</code></td>
<td>无</td>
</tr>
<tr>
<td>停止Pod</td>
<td>无</td>
<td>无</td>
<td><code>crictl stopp</code></td>
<td>无</td>
</tr>
<tr>
<td>删除Pod</td>
<td>无</td>
<td>无</td>
<td><code>crictl rmp</code></td>
<td>无</td>
</tr>
</tbody></table>
<p><strong>总结</strong></p>
<ul>
<li><strong>Docker</strong>：用户友好，功能全面，适合独立容器管理和开发环境。</li>
<li><strong>ctr</strong>：轻量、低级工具，适合直接与 containerd 交互，主要用于调试和底层管理。</li>
<li><strong>nerdctl</strong>：兼容 Docker CLI，适合那些想使用 Docker 命令但又希望直接使用 containerd 的用户。</li>
<li><strong>crictl</strong>：Kubernetes 环境下的调试工具，专注于 CRI 兼容的运行时，不适合一般的开发场景。</li>
</ul>
<p>其中nerdctl 是轻量化的 containerd 替代方案，crictl 是基于 Kubernetes CRI交互的Pod管理工具。</p>
<h2 id="Containerd使用指南"><a href="#Containerd使用指南" class="headerlink" title="Containerd使用指南"></a>Containerd使用指南</h2><p>nerdctl 是一个与 docker cli 风格兼容的 containerd 客户端工具，而且直接兼容 docker compose 的语法的，这就大大提高了直接将 containerd 作为本地开发、测试或者单机容器部署使用的效率。</p>
<h3 id="1-安装"><a href="#1-安装" class="headerlink" title="1. 安装"></a>1. 安装</h3><p>同样直接在 GitHub Release 页面下载对应的压缩包解压到 PATH 路径下即可：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"># 如果没有安装 containerd，则可以下载 nerdctl-full-&lt;VERSION&gt;-linux-amd64.tar.gz 包进行安装</span><br><span class="line">➜  ~ wget https://github.com/containerd/nerdctl/releases/download/v1.7.5/nerdctl-1.7.5-linux-amd64.tar.gz</span><br><span class="line"></span><br><span class="line">➜  ~ mkdir -p /usr/local/containerd/bin/ &amp;&amp; tar -zxvf nerdctl-1.7.5-linux-amd64.tar.gz nerdctl &amp;&amp; mv nerdctl /usr/local/containerd/bin/</span><br><span class="line">➜  ~ ln -s /usr/local/containerd/bin/nerdctl /usr/local/bin/nerdctl</span><br><span class="line">➜  ~ nerdctl version</span><br><span class="line">WARN[0000] unable to determine buildctl version: exec: &quot;buildctl&quot;: executable file not found in $PATH </span><br><span class="line">Client:</span><br><span class="line"> Version:	v1.7.5</span><br><span class="line"> OS/Arch:	linux/amd64</span><br><span class="line"> Git commit:	cffed372371dcbea3dc9a646ce5a913fc1c09513</span><br><span class="line"> buildctl:</span><br><span class="line">  Version:	</span><br><span class="line"></span><br><span class="line">Server:</span><br><span class="line"> containerd:</span><br><span class="line">  Version:	v2.0.0-beta.2-33-g96bf529cb</span><br><span class="line">  GitCommit:	96bf529cbf55940ddb96bb8adc8be51b11922ebb</span><br><span class="line"> runc:</span><br><span class="line">  Version:	1.1.4</span><br><span class="line">  GitCommit:	v1.1.4-0-g5fd4c4d</span><br></pre></td></tr></table></figure>

<p>安装完成后接下来学习下 <code>nerdctl</code> 命令行工具的使用。</p>
<h3 id="2-命令简介"><a href="#2-命令简介" class="headerlink" title="2. 命令简介"></a>2. 命令简介</h3><h4 id="容器管理"><a href="#容器管理" class="headerlink" title="容器管理"></a>容器管理</h4><p><strong>run</strong></p>
<p>和 <code>docker run</code> 类似可以使用 <code>nerdctl run</code> 命令运行容器，例如：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">➜  ~ nerdctl run -d -p 80:80 --name=nginx --restart=always nginx:alpine</span><br><span class="line">docker.io/library/nginx:alpine:                                                   resolved       |++++++++++++++++++++++++++++++++++++++|</span><br><span class="line">index-sha256:bead42240255ae1485653a956ef41c9e458eb077fcb6dc664cbc3aa9701a05ce:    done           |++++++++++++++++++++++++++++++++++++++| manifest-sha256:ce6ca11a3fa7e0e6b44813901e3289212fc2f327ee8b1366176666e8fb470f24: done           |++++++++++++++++++++++++++++++++++++++| config-sha256:7ce0143dee376bfd2937b499a46fb110bda3c629c195b84b1cf6e19be1a9e23b:   done           |++++++++++++++++++++++++++++++++++++++| elapsed: 5.3 s                                                                    total:  3.1 Ki (606.0 B/s)                                       6e489777d2f73dda8a310cdf8da9df38353c1aa2021d3c2270b30eff1806bcf8</span><br></pre></td></tr></table></figure>

<p>可选的参数使用和 <code>docker run</code> 基本一直，比如 <code>-i</code>、<code>-t</code>、<code>--cpus</code>、<code>--memory</code> 等选项，可以使用 <code>nerdctl run --help</code> 获取可使用的命令选项：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br></pre></td><td class="code"><pre><span class="line">[root@192 containerd]# nerdctl run --help</span><br><span class="line">Run a command in a new container. Optionally specify &quot;ipfs://&quot; or &quot;ipns://&quot; scheme to pull image from IPFS.</span><br><span class="line"></span><br><span class="line">Usage: nerdctl run [flags] IMAGE [COMMAND] [ARG...]</span><br><span class="line"></span><br><span class="line">Flags:</span><br><span class="line">      --add-host strings                               Add a custom host-to-IP mapping (host:ip)</span><br><span class="line">      --blkio-weight uint16                            Block IO (relative weight), between 10 and 1000, or 0 to disable (default 0)</span><br><span class="line">      --cap-add strings                                Add Linux capabilities</span><br><span class="line">      --cap-drop strings                               Drop Linux capabilities</span><br><span class="line">      --cgroup-conf strings                            Configure cgroup v2 (key=value)</span><br><span class="line">      --cgroup-parent string                           Optional parent cgroup for the container</span><br><span class="line">      --cgroupns string                                Cgroup namespace to use, the default depends on the cgroup version (&quot;host&quot;|&quot;private&quot;) (default &quot;private&quot;)</span><br><span class="line">      --cidfile string                                 Write the container ID to the file</span><br><span class="line">      --cosign-certificate-identity string             The identity expected in a valid Fulcio certificate for --verify=cosign. Valid values include email address, DNS names, IP addresses, and URIs. Either --cosign-certificate-identity or --cosign-certificate-identity-regexp must be set for keyless flows</span><br><span class="line">      --cosign-certificate-identity-regexp string      A regular expression alternative to --cosign-certificate-identity for --verify=cosign. Accepts the Go regular expression syntax described at https://golang.org/s/re2syntax. Either --cosign-certificate-identity or --cosign-certificate-identity-regexp must be set for keyless flows</span><br><span class="line">      --cosign-certificate-oidc-issuer string          The OIDC issuer expected in a valid Fulcio certificate for --verify=cosign, e.g. https://token.actions.githubusercontent.com or https://oauth2.sigstore.dev/auth. Either --cosign-certificate-oidc-issuer or --cosign-certificate-oidc-issuer-regexp must be set for keyless flows</span><br><span class="line">      --cosign-certificate-oidc-issuer-regexp string   A regular expression alternative to --certificate-oidc-issuer for --verify=cosign. Accepts the Go regular expression syntax described at https://golang.org/s/re2syntax. Either --cosign-certificate-oidc-issuer or --cosign-certificate-oidc-issuer-regexp must be set for keyless flows</span><br><span class="line">      --cosign-key string                              Path to the public key file, KMS, URI or Kubernetes Secret for --verify=cosign</span><br><span class="line">      --cpu-period uint                                Limit CPU CFS (Completely Fair Scheduler) period</span><br><span class="line">      --cpu-quota int                                  Limit CPU CFS (Completely Fair Scheduler) quota (default -1)</span><br><span class="line">      --cpu-shares uint                                CPU shares (relative weight)</span><br><span class="line">      --cpus float                                     Number of CPUs</span><br><span class="line">      --cpuset-cpus string                             CPUs in which to allow execution (0-3, 0,1)</span><br><span class="line">      --cpuset-mems string                             MEMs in which to allow execution (0-3, 0,1)</span><br><span class="line">  -d, --detach                                         Run container in background and print container ID</span><br><span class="line">      --detach-keys string                             Override the default detach keys (default &quot;ctrl-p,ctrl-q&quot;)</span><br><span class="line">      --device strings                                 Add a host device to the container</span><br><span class="line">      --dns strings                                    Set custom DNS servers</span><br><span class="line">      --dns-opt strings                                Set DNS options</span><br><span class="line">      --dns-option strings                             Set DNS options</span><br><span class="line">      --dns-search strings                             Set custom DNS search domains</span><br><span class="line">      --entrypoint stringArray                         Overwrite the default ENTRYPOINT of the image</span><br><span class="line">  -e, --env stringArray                                Set environment variables</span><br><span class="line">      --env-file strings                               Set environment variables from file</span><br><span class="line">      --gpus stringArray                               GPU devices to add to the container (&#x27;all&#x27; to pass all GPUs)</span><br><span class="line">      --group-add strings                              Add additional groups to join</span><br><span class="line">      --help                                           show help</span><br><span class="line">  -h, --hostname string                                Container host name</span><br><span class="line">      --init                                           Run an init process inside the container, Default to use tini</span><br><span class="line">      --init-binary string                             The custom binary to use as the init process (default &quot;tini&quot;)</span><br><span class="line">  -i, --interactive                                    Keep STDIN open even if not attached</span><br><span class="line">      --ip string                                      IPv4 address to assign to the container</span><br><span class="line">      --ip6 string                                     IPv6 address to assign to the container</span><br><span class="line">      --ipc string                                     IPC namespace to use (&quot;host&quot;|&quot;private&quot;)</span><br><span class="line">      --ipfs-address string                            multiaddr of IPFS API (default uses $IPFS_PATH env variable if defined or local directory ~/.ipfs)</span><br><span class="line">      --isolation string                               Specify isolation technology for container. On Linux the only valid value is default. Windows options are host, process and hyperv with process isolation as the default (default &quot;default&quot;)</span><br><span class="line">      --kernel-memory string                           Kernel memory limit (deprecated)</span><br><span class="line">  -l, --label stringArray                              Set metadata on container</span><br><span class="line">      --label-file strings                             Set metadata on container from file</span><br><span class="line">      --log-driver string                              Logging driver for the container. Default is json-file. It also supports logURI (eg: --log-driver binary://&lt;path&gt;) (default &quot;json-file&quot;)</span><br><span class="line">      --log-opt stringArray                            Log driver options</span><br><span class="line">      --mac-address string                             MAC address to assign to the container</span><br><span class="line">  -m, --memory string                                  Memory limit</span><br><span class="line">      --memory-reservation string                      Memory soft limit</span><br><span class="line">      --memory-swap string                             Swap limit equal to memory plus swap: &#x27;-1&#x27; to enable unlimited swap</span><br><span class="line">      --memory-swappiness int                          Tune container memory swappiness (0 to 100) (default -1) (default -1)</span><br><span class="line">      --mount stringArray                              Attach a filesystem mount to the container</span><br><span class="line">      --name string                                    Assign a name to the container</span><br><span class="line">      --net strings                                    Connect a container to a network (&quot;bridge&quot;|&quot;host&quot;|&quot;none&quot;|&lt;CNI&gt;) (default [bridge])</span><br><span class="line">      --network strings                                Connect a container to a network (&quot;bridge&quot;|&quot;host&quot;|&quot;none&quot;|&quot;container:&lt;container&gt;&quot;|&lt;CNI&gt;) (default [bridge])</span><br><span class="line">      --oom-kill-disable                               Disable OOM Killer</span><br><span class="line">      --oom-score-adj int                              Tune container’s OOM preferences (-1000 to 1000, rootless: 100 to 1000)</span><br><span class="line">      --pid string                                     PID namespace to use</span><br><span class="line">      --pidfile string                                 file path to write the task&#x27;s pid</span><br><span class="line">      --pids-limit int                                 Tune container pids limit (set -1 for unlimited) (default -1)</span><br><span class="line">      --platform string                                Set platform (e.g. &quot;amd64&quot;, &quot;arm64&quot;)</span><br><span class="line">      --privileged                                     Give extended privileges to this container</span><br><span class="line">  -p, --publish strings                                Publish a container&#x27;s port(s) to the host</span><br><span class="line">      --pull string                                    Pull image before running (&quot;always&quot;|&quot;missing&quot;|&quot;never&quot;) (default &quot;missing&quot;)</span><br><span class="line">      --rdt-class string                               Name of the RDT class (or CLOS) to associate the container with</span><br><span class="line">      --read-only                                      Mount the container&#x27;s root filesystem as read only</span><br><span class="line">      --restart string                                 Restart policy to apply when a container exits (implemented values: &quot;no&quot;|&quot;always|on-failure:n|unless-stopped&quot;) (default &quot;no&quot;)</span><br><span class="line">      --rm                                             Automatically remove the container when it exits</span><br><span class="line">      --rootfs                                         The first argument is not an image but the rootfs to the exploded container</span><br><span class="line">      --runtime string                                 Runtime to use for this container, e.g. &quot;crun&quot;, or &quot;io.containerd.runsc.v1&quot; (default &quot;io.containerd.runc.v2&quot;)</span><br><span class="line">      --security-opt stringArray                       Security options</span><br><span class="line">      --shm-size string                                Size of /dev/shm</span><br><span class="line">      --stop-signal string                             Signal to stop a container (default &quot;SIGTERM&quot;)</span><br><span class="line">      --stop-timeout int                               Timeout (in seconds) to stop a container</span><br><span class="line">      --sysctl stringArray                             Sysctl options</span><br><span class="line">      --tmpfs stringArray                              Mount a tmpfs directory</span><br><span class="line">  -t, --tty                                            Allocate a pseudo-TTY</span><br><span class="line">      --ulimit strings                                 Ulimit options</span><br><span class="line">      --umask string                                   Set the umask inside the container. Defaults to 0022</span><br><span class="line">  -u, --user string                                    Username or UID (format: &lt;name|uid&gt;[:&lt;group|gid&gt;])</span><br><span class="line">      --uts string                                     UTS namespace to use</span><br><span class="line">      --verify string                                  Verify the image (none|cosign|notation) (default &quot;none&quot;)</span><br><span class="line">  -v, --volume stringArray                             Bind mount a volume</span><br><span class="line">      --volumes-from stringArray                       Mount volumes from the specified container(s)</span><br><span class="line">  -w, --workdir string                                 Working directory inside the container</span><br><span class="line"></span><br><span class="line">See also &#x27;nerdctl --help&#x27; for the global flags such as &#x27;--namespace&#x27;, &#x27;--snapshotter&#x27;, and &#x27;--cgroup-manager&#x27;.</span><br></pre></td></tr></table></figure>

<p><strong>exec</strong></p>
<p>同样也可以使用 <code>exec</code> 命令执行容器相关命令，例如：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">➜  ~ nerdctl exec -it ea07355852eb date</span><br><span class="line">Mon Nov 18 03:15:06 UTC 2024</span><br></pre></td></tr></table></figure>

<p><strong>ps</strong></p>
<p>使用 <code>nerdctl ps</code> 命令可以列出所有容器，与docker不同的是，其提供了基于namespace的隔离，如果需要查看k8s的容器，需要增加<code>-n k8s.io</code></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">➜  ~ nerdctl -n k8s.io ps</span><br><span class="line">CONTAINER ID    IMAGE                                                                      COMMAND                   CREATED       STATUS    PORTS    NAMES</span><br><span class="line">e7f156d31942    docker.io/prom/node-exporter:v1.4.0                                        &quot;/bin/node_exporter …&quot;    2 days ago    Up                 k8s://node-exporter/node-exporter-5zhjt/main</span><br><span class="line">bf1704937991    hub.cloud.ctripcorp.com/k8s-mirror/pause-amd64:3.1                         &quot;/pause&quot;                  2 days ago    Up                 k8s://node-exporter/node-exporter-5zhjt</span><br></pre></td></tr></table></figure>

<p>同样可以使用 <code>-a</code> 选项显示所有的容器列表，默认只显示正在运行的容器，不过需要注意的是 <code>nerdctl ps</code> 命令并没有实现 <code>docker ps</code> 下面的 <code>--filter</code>、<code>--format</code>、<code>--last</code>、<code>--size</code> 等选项。</p>
<p><strong>inspect</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">➜  ~ nerdctl -n k8s.io inspect e7f156d31942</span><br><span class="line">[</span><br><span class="line">    &#123;</span><br><span class="line">        &quot;Id&quot;: &quot;e7f156d31942ffec027b48d50d787e18c59e24ae8134f06ee25dab6c74220d83&quot;,</span><br><span class="line">        &quot;Created&quot;: &quot;2024-11-15T08:37:07.845392486Z&quot;,</span><br><span class="line">        &quot;Path&quot;: &quot;/bin/node_exporter&quot;,</span><br><span class="line">        &quot;Args&quot;: [</span><br><span class="line">           ...</span><br><span class="line">        ],</span><br><span class="line">        &quot;State&quot;: &#123;</span><br><span class="line">            &quot;Status&quot;: &quot;running&quot;,</span><br><span class="line">            &quot;Running&quot;: true,</span><br><span class="line">            &quot;Paused&quot;: false,</span><br><span class="line">            &quot;Restarting&quot;: false,</span><br><span class="line">            &quot;Pid&quot;: 22800,</span><br><span class="line">            &quot;ExitCode&quot;: 0,</span><br><span class="line">            &quot;Error&quot;: &quot;&quot;,</span><br><span class="line">            &quot;StartedAt&quot;: &quot;&quot;,</span><br><span class="line">            &quot;FinishedAt&quot;: &quot;&quot;</span><br><span class="line">        &#125;,</span><br><span class="line">        &quot;Image&quot;: &quot;docker.io/prom/node-exporter:v1.4.0&quot;,</span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<p>可以看到显示结果和 <code>docker inspect</code> 也基本一致的。</p>
<p><strong>logs</strong></p>
<p>查看容器日志是我们平时经常会使用到的一个功能，同样我们可以使用 <code>nerdctl logs</code> 来获取日志数据：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">➜  ~ nerdctl -n k8s.io logs e7f156d31942 |more</span><br><span class="line">ts=2024-11-15T08:37:07.980Z caller=node_exporter.go:182 level=info msg=&quot;Starting node_exporter&quot; version=&quot;(version=1.4.0, branch=HEAD, revision=7da1321761b3b8dfc9e496e1a60e6a476fec6018)&quot;</span><br><span class="line">ts=2024-11-15T08:37:07.980Z caller=node_exporter.go:183 level=info msg=&quot;Build context&quot; build_context=&quot;(go=go1.19.1, user=root@83d90983e89c, date=20220926-12:32:56)&quot;</span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<p>同样支持 <code>-f</code>、<code>-t</code>、<code>-n</code>、<code>--since</code>、<code>--until</code> 这些选项。</p>
<p><strong>stop</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">➜  ~ nerdctl -n k8s.io stop e7f156d31942</span><br><span class="line">FATA[0000] 1 errors:</span><br><span class="line">unable to cleanup network for container: e7f156d31942</span><br></pre></td></tr></table></figure>

<p><strong>rm</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">➜  ~ nerdctl -n k8s.io rm e7f156d31942 </span><br><span class="line">FATA[0000] 1 errors:</span><br><span class="line">container e7f156d31942ffec027b48d50d787e18c59e24ae8134f06ee25dab6c74220d83 is in running status. unpause/stop container first or force removal </span><br><span class="line">➜  ~ nerdctl -n k8s.io rm -f e7f156d31942 </span><br><span class="line">ERRO[0000] 1 errors:</span><br><span class="line">failed to load container networking options from specs: unexpected end of JSON input </span><br></pre></td></tr></table></figure>

<p>要强制删除同样可以使用 <code>-f</code> 或 <code>--force</code> 选项来操作。</p>
<h4 id="镜像管理"><a href="#镜像管理" class="headerlink" title="镜像管理"></a>镜像管理</h4><p><strong>images</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">➜  ~ nerdctl -n k8s.io images|grep 4a2c72aa0e18</span><br><span class="line">prom/node-exporter                                                 &lt;none&gt;                4a2c72aa0e18    2 days ago    linux/amd64    24.56MB    11.47MB</span><br><span class="line">&lt;none&gt;                                                             &lt;none&gt;                4a2c72aa0e18    2 days ago    linux/amd64    24.56MB    11.47MB</span><br><span class="line">prom/node-exporter                                                 v1.4.0                4a2c72aa0e18    2 days ago    linux/amd64    24.56MB    11.47MB</span><br></pre></td></tr></table></figure>

<p>通过cri方式获取的镜像，containerd会生成三个镜像，分为为tag、sha256以及digest，另外需要注意的是<code>docker images</code> 的一些选项暂未实现，比如 <code>--filter</code>、<code>--format</code>。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">[root@192 containerd]# nerdctl image --help</span><br><span class="line">Manage images</span><br><span class="line"></span><br><span class="line">Usage: nerdctl image [flags]</span><br><span class="line"></span><br><span class="line">Commands:</span><br><span class="line">  build    Build an image from a Dockerfile. Needs buildkitd to be running.</span><br><span class="line">  convert  convert an image</span><br><span class="line">  decrypt  decrypt an image</span><br><span class="line">  encrypt  encrypt image layers</span><br><span class="line">  history  Show the history of an image</span><br><span class="line">  inspect  Display detailed information on one or more images.</span><br><span class="line">  load     Load an image from a tar archive or STDIN</span><br><span class="line">  ls       List images</span><br><span class="line">  prune    Remove unused images</span><br><span class="line">  pull     Pull an image from a registry. Optionally specify &quot;ipfs://&quot; or &quot;ipns://&quot; scheme to pull image from IPFS.</span><br><span class="line">  push     Push an image or a repository to a registry. Optionally specify &quot;ipfs://&quot; or &quot;ipns://&quot; scheme to push image to IPFS.</span><br><span class="line">  rm       Remove one or more images</span><br><span class="line">  save     Save one or more images to a tar archive (streamed to STDOUT by default)</span><br><span class="line">  tag      Create a tag TARGET_IMAGE that refers to SOURCE_IMAGE</span><br><span class="line"></span><br><span class="line">Flags:</span><br><span class="line">  -h, --help   help for image</span><br></pre></td></tr></table></figure>



<p><strong>pull</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">➜  ~ nerdctl -n k8s.io pull prom/node-exporter:v1.4.0</span><br><span class="line">docker.io/prom/node-exporter:v1.4.0:                                              resolved       |++++++++++++++++++++++++++++++++++++++| </span><br><span class="line">index-sha256:4a2c72aa0e18fcedfa86e4a2ca5cf8e33010246e3125449015b586f4fcde7f01:    exists         |++++++++++++++++++++++++++++++++++++++| </span><br><span class="line">manifest-sha256:2d9dcdf0b2226f0c3d550a64d2667710265462350a3ba9ebe37d0302bc64af0f: exists         |++++++++++++++++++++++++++++++++++++++| </span><br><span class="line">config-sha256:d3e443c987ef405e1be101647873d86b5729c9c47bb1dd1ab59ccb24bc9e322c:   exists         |++++++++++++++++++++++++++++++++++++++| </span><br><span class="line">elapsed: 0.5 s                                                                    total:   0.0 B (0.0 B/s)</span><br></pre></td></tr></table></figure>

<p><strong>push</strong></p>
<p>当然在推送镜像之前也可以使用 <code>nerdctl login</code> 命令登录到镜像仓库，然后再执行 push 操作。</p>
<p>可以使用 <code>nerdctl login</code> 进行登录，使用 <code>nerdctl logout</code> 可以注销退出登录。</p>
<p><strong>tag</strong></p>
<p>使用 <code>tag</code> 命令可以为一个镜像创建一个别名镜像：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">➜  ~ nerdctl -n k8s.io images</span><br><span class="line">REPOSITORY    TAG                  IMAGE ID        CREATED           SIZE</span><br><span class="line">prom/node-exporter                                                 &lt;none&gt;                4a2c72aa0e18    2 days ago    linux/amd64    24.56MB    11.47MB</span><br><span class="line">&lt;none&gt;                                                             &lt;none&gt;                4a2c72aa0e18    2 days ago    linux/amd64    24.56MB    11.47MB</span><br><span class="line">prom/node-exporter                                                 v1.4.0                4a2c72aa0e18    2 days ago    linux/amd64    24.56MB    11.47MB</span><br><span class="line">➜  ~ nerdctl -n k8s.io tag prom/node-exporter:v1.4.0 prom/node-exporter:v1.4.1</span><br><span class="line">➜  ~ nerdctl -n k8s.io images|grep 4a2c72aa0e18</span><br><span class="line">prom/node-exporter                                                 v1.4.1                4a2c72aa0e18    4 seconds ago    linux/amd64    24.56MB    11.47MB</span><br><span class="line">prom/node-exporter                                                 &lt;none&gt;                4a2c72aa0e18    2 days ago       linux/amd64    24.56MB    11.47MB</span><br><span class="line">&lt;none&gt;                                                             &lt;none&gt;                4a2c72aa0e18    2 days ago       linux/amd64    24.56MB    11.47MB</span><br><span class="line">prom/node-exporter                                                 v1.4.0                4a2c72aa0e18    2 days ago       linux/amd64    24.56MB    11.47MB</span><br></pre></td></tr></table></figure>

<p><strong>save</strong></p>
<p>使用 <code>save</code> 命令可以导出镜像为一个 <code>tar</code> 压缩包。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">➜  ~ nerdctl save -o busybox.tar.gz busybox:latest</span><br><span class="line">➜  ~ ls -lh busybox.tar.gz</span><br><span class="line">-rw-r--r-- 1 root root 761K Aug 19 15:19 busybox.tar.gz</span><br></pre></td></tr></table></figure>

<p><strong>rmi</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">➜  ~ nerdctl -n k8s.io rmi prom/node-exporter:v1.4.1</span><br><span class="line">Untagged: docker.io/prom/node-exporter:v1.4.1@sha256:4a2c72aa0e18fcedfa86e4a2ca5cf8e33010246e3125449015b586f4fcde7f01</span><br><span class="line">Deleted: sha256:084326605ab6715ca698453e530e4d0319d4e402b468894a06affef944b4ef04</span><br><span class="line">Deleted: sha256:5295faa045209ff9800d03fe1ccc94431dac6a54dac2edc7f6d06ee1e58bb0be</span><br><span class="line">Deleted: sha256:bebdf9d4bf7bd2bd40a7e73e5f09a86a87e34578b622328d5a58bf01353f9def</span><br></pre></td></tr></table></figure>

<p><strong>load</strong></p>
<p>使用 <code>load</code> 命令可以将上面导出的镜像再次导入：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">➜  ~ nerdctl load -i busybox.tar.gz</span><br><span class="line">unpacking docker.io/library/busybox:latest (sha256:0f354ec1728d9ff32edcd7d1b8bbdfc798277ad36120dc3dc683be44524c8b60)...done</span><br></pre></td></tr></table></figure>

<p>使用 <code>-i</code> 或 <code>--input</code> 选项指定需要导入的压缩包。</p>
<p><strong>build</strong></p>
<p> <code>nerdctl build</code> 需要依赖 <code>buildkit</code> 工具。</p>
<p><a target="_blank" rel="noopener" href="https://github.com/moby/buildkit">buildkit</a> 是 Docker 公司开源的一个构建工具包，支持 OCI 标准的镜像构建。它主要包含以下部分:</p>
<ul>
<li>服务端 <code>buildkitd</code>：当前支持 runc 和 containerd 作为 worker，默认是 runc，我们这里使用 containerd</li>
<li>客户端 <code>buildctl</code>：负责解析 Dockerfile，并向服务端 buildkitd 发出构建请求</li>
</ul>
<p>构建完成后查看镜像是否构建成功：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">➜  ~ ➜  ~ nerdctl -n k8s.io images</span><br><span class="line">REPOSITORY    TAG                  IMAGE ID        CREATED           SIZE</span><br><span class="line">prom/node-exporter                                                 &lt;none&gt;                4a2c72aa0e18    2 days ago    linux/amd64    24.56MB    11.47MB</span><br><span class="line">&lt;none&gt;                                                             &lt;none&gt;                4a2c72aa0e18    2 days ago    linux/amd64    24.56MB    11.47MB</span><br><span class="line">prom/node-exporter                                                 v1.4.0                4a2c72aa0e18    2 days ago    linux/amd64    24.56MB    11.47MB</span><br></pre></td></tr></table></figure>

<p>这样我们就使用 <code>nerdctl + buildkitd</code> 轻松完成了容器镜像的构建。</p>
<h4 id="compose"><a href="#compose" class="headerlink" title="compose"></a>compose</h4><p>当然，如果你希望在单机环境下使用 Docker Compose，但想使用 <code>containerd</code>，<code>nerdctl</code> 提供了对 Compose 功能的兼容支持。我们可以使用以下 <code>nerdctl compose</code> 系列命令来管理 Compose 服务：</p>
<ol>
<li><p><strong>启动 Compose 服务</strong>：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nerdctl compose up</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>查看服务日志</strong>：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nerdctl compose logs</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>构建镜像</strong>：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nerdctl compose build</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>停止并删除服务</strong>：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nerdctl compose down</span><br></pre></td></tr></table></figure></li>
</ol>
<p>通过结合 <code>containerd</code>、<code>nerdctl</code> 和 <code>buildkit</code>，您可以在镜像构建和容器管理方面完全替代 Docker，提供高效和轻量的容器管理体验。这种方式特别适合希望利用 <code>containerd</code> 的轻量特性，同时又不想放弃 Docker Compose 的用户。</p>
<h2 id="CRICTL使用指南"><a href="#CRICTL使用指南" class="headerlink" title="CRICTL使用指南"></a>CRICTL使用指南</h2><p><code>crictl</code> 可以追溯到 Kubernetes 中的容器运行时接口（CRI）。在 Kubernetes 1.5 版本中引入了 CRI，它定义了 Kubernetes 和容器运行时之间的标准化接口，以便 Kubernetes 可以与不同的容器运行时（如 Docker、containerd、CRI-O 等）进行交互。</p>
<p>由于 Kubernetes 对容器运行时的要求日益严格，需要更多的运行时特性和更高的性能，因此出现了对 CRI 的更高需求。而且，CRI 也为容器运行时的实现提供了标准化的接口，使得开发人员可以更轻松地实现自己的容器运行时。</p>
<p>在这样的背景下，<code>crictl</code> 作为一个命令行工具被开发出来，用于与符合 CRI 标准的容器运行时进行交互。它使得用户可以方便地管理容器和容器镜像，查询容器状态和元数据，并进行容器日志查看等操作。<code>crictl</code> 的出现使得容器运行时的管理和调试变得更加便捷，同时也促进了 CRI 标准的推广和应用。</p>
<p>以下是 <code>crictl</code> 常见的用法和功能：</p>
<ol>
<li><strong>容器管理</strong>：<code>crictl</code> 可以用来启动、停止、删除和查询容器的状态。</li>
<li><strong>容器镜像管理</strong>：<code>crictl</code> 可以用来拉取、推送、删除和查询容器镜像。</li>
<li><strong>容器日志查看</strong>：<code>crictl</code> 可以用来查看容器的标准输出和标准错误日志。</li>
<li><strong>容器信息查询</strong>：<code>crictl</code> 可以用来查询容器的详细信息，如 ID、名称、状态、IP 等。</li>
<li><strong>容器元数据操作</strong>：<code>crictl</code> 还可以进行容器元数据的操作，如注解和标签的添加和删除。</li>
</ol>
<p><code>crictl</code> 是一个强大的工具，可以帮助您管理容器运行时中的容器和容器镜像，以及了解容器的状态和元数据。它通常用于调试和管理容器化应用程序，并与 Kubernetes 等容器编排系统集成使用。</p>
<h3 id="1-安装-1"><a href="#1-安装-1" class="headerlink" title="1. 安装"></a>1. 安装</h3><p>首先我们需要先安装 <code>crictl</code> 工具，直接从 <a target="_blank" rel="noopener" href="https://github.com/kubernetes-sigs/cri-tools">cri-tools</a> 的 release 页面下载对应的二进制包，解压放入 PATH 路径下即可：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">➜  ~ VERSION=&quot;v1.22.0&quot;</span><br><span class="line">➜  ~ wget https://github.com/kubernetes-sigs/cri-tools/releases/download/$VERSION/crictl-$VERSION-linux-amd64.tar.gz</span><br><span class="line"># 如果有限制，也可以替换成下面的 URL 加速下载</span><br><span class="line"># wget https://download.fastgit.org/kubernetes-sigs/cri-tools/releases/download/$VERSION/crictl-$VERSION-linux-amd64.tar.gz</span><br><span class="line">➜  ~ tar zxvf crictl-$VERSION-linux-amd64.tar.gz -C /usr/local/bin</span><br><span class="line">➜  ~ rm -f crictl-$VERSION-linux-amd64.tar.gz</span><br><span class="line">➜  ~ crictl -v</span><br><span class="line">crictl version v1.22.0</span><br></pre></td></tr></table></figure>

<p>到这里证明 <code>crictl</code> 工具安装成功了。</p>
<h3 id="2-命令简介-1"><a href="#2-命令简介-1" class="headerlink" title="2. 命令简介"></a>2. 命令简介</h3><p><code>crictl</code> 安装完成后，接下来我们来了解下该工具的一些常见使用方法。</p>
<p>首先需要修改下默认的配置文件，默认为 <code>/etc/crictl.yaml</code>，在文件中指定容器运行时和镜像的 endpoint 地址，内容如下所示：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">runtime-endpoint: unix:///var/run/containerd/containerd.sock</span><br><span class="line">image-endpoint: unix:///var/run/containerd/containerd.sock</span><br><span class="line">debug: false</span><br><span class="line">pull-image-on-create: false</span><br><span class="line">disable-pull-on-run: false</span><br></pre></td></tr></table></figure>

<p>配置完成后就可以使用 <code>crictl</code> 命令了。</p>
<p><strong>Pod 管理</strong></p>
<p>通过 <code>crictl pods</code> 命令可以获取当前节点上运行的 Pods 列表，如下所示：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">➜  ~ crictl pods</span><br><span class="line">POD ID              CREATED             STATE               NAME                       NAMESPACE           ATTEMPT             RUNTIME</span><br><span class="line">1f617ebf0524c       8 weeks ago         Ready               node-exporter-ggjwf                node-exporter       0                   (default)</span><br><span class="line">4b93e3d6e8d1f       2 months ago        Ready               node-problem-detector-r6ps6        kube-system         0                   (default)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>还可以使用 <code>--name</code> 参数获取指定的 Pod，也可以根据标签来筛选 Pod 列表：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">➜  ~ crictl pods --label app=node-exporter</span><br><span class="line">POD ID              CREATED             STATE               NAME                  NAMESPACE           ATTEMPT             RUNTIME</span><br><span class="line">1f617ebf0524c       8 weeks ago         Ready               node-exporter-ggjwf   node-exporter       0                   (default)</span><br></pre></td></tr></table></figure>

<p><strong>镜像管理</strong></p>
<p>使用 <code>crictl images</code> 命令可以获取所有的镜像：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">➜  ~ crictl images</span><br><span class="line">IMAGE                                     TAG                 IMAGE ID            SIZE</span><br><span class="line">hub.cloud.ctripcorp.com/prom/node-exporter                                            v1.4.0                                                                                    d3e443c987ef4       11.5MB</span><br></pre></td></tr></table></figure>

<p>同样在命令后面可以加上 <code>-v</code> 参数来显示镜像的详细信息：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">➜  ~ crictl images -v</span><br><span class="line">ID: sha256:d3e443c987ef405e1be101647873d86b5729c9c47bb1dd1ab59ccb24bc9e322c</span><br><span class="line">RepoTags: docker.io/prom/node-exporter:v1.4.0</span><br><span class="line">RepoDigests: docker.io/prom/node-exporter@sha256:4a2c72aa0e18fcedfa86e4a2ca5cf8e33010246e3125449015b586f4fcde7f01</span><br><span class="line">Size: 11474514</span><br><span class="line">Username: nobody</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">......</span><br></pre></td></tr></table></figure>

<p><strong>容器管理</strong></p>
<p>使用 <code>crictl ps</code> 命令可以获取正在运行的容器列表：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">➜  ~ crictl ps</span><br><span class="line">CONTAINER           IMAGE               CREATED             STATE               NAME                ATTEMPT             POD ID</span><br><span class="line">e7f156d31942f       d3e443c987ef4       2 days ago          Running             main                    2                   bf1704937991a       node-exporter-5zhjt</span><br></pre></td></tr></table></figure>

<p>还有更多其他可选参数，使用 <code>-s</code> 选项按照状态进行过滤：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">➜  ~ crictl ps -s Exited</span><br><span class="line">CONTAINER           IMAGE               CREATED             STATE               NAME                    ATTEMPT             POD ID              POD</span><br><span class="line">22a0adacf702f       d3e443c987ef4       2 days ago          Exited              main                    1                   bf1704937991a       node-exporter-5zhjt</span><br></pre></td></tr></table></figure>

<p><code>crictl</code> 也有类似 <code>exec</code> 的命令支持，比如在容器 ID 为 <code>e7f156d31942f</code> 的容器中执行一个 <code>whoami</code> 命令：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">➜  ~  crictl exec -it e7f156d31942f whoami</span><br><span class="line">root</span><br></pre></td></tr></table></figure>

<p>还可以获取容器日志信息：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">➜  ~ crictl logs e7f156d31942f </span><br><span class="line">ts=2024-11-15T08:37:07.980Z caller=node_exporter.go:182 level=info msg=&quot;Starting node_exporter&quot; version=&quot;(version=1.4.0, branch=HEAD, revision=7da1321761b3b8dfc9e496e1a60e6a476fec6018)&quot;</span><br><span class="line">ts=2024-11-15T08:37:07.980Z caller=node_exporter.go:183 level=info msg=&quot;Build context&quot; build_context=&quot;(go=go1.19.1, user=root@83d90983e89c, date=20220926-12:32:56)&quot;</span><br><span class="line">ts=2024-11-15T08:37:07.980Z caller=node_exporter.go:185 level=warn msg=&quot;Node Exporter is running as root user. This exporter is designed to run as unprivileged user, root is not required.&quot;</span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<p>和 <code>kubectl logs</code> 类似于，还可以使用 <code>-f</code> 选项来 Follow 日志输出，<code>--tail N</code> 也可以指定输出最近的 <code>N</code> 行日志。</p>
<p>使用 <code>crictl stats</code> 命令可以列出所有或者单一容器资源的使用情况：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">➜  ~ crictl stats e7f156d31942f </span><br><span class="line"></span><br><span class="line">CONTAINER           NAME                CPU %               MEM                 DISK                INODES</span><br><span class="line">e7f156d31942f       main                0.00                37.13MB             0B                  18</span><br></pre></td></tr></table></figure>

<p>此外镜像和容器相关的一些操作也都支持，更多信息请参考 <a target="_blank" rel="noopener" href="https://github.com/kubernetes-sigs/cri-tools">kubernetes-sigs&#x2F;cri-tools</a>。</p>
<h2 id="链接"><a href="#链接" class="headerlink" title="链接"></a>链接</h2><ol>
<li><a target="_blank" rel="noopener" href="https://kubernetes.io/zh-cn/docs/setup/production-environment/container-runtimes/">https://kubernetes.io/zh-cn/docs/setup/production-environment/container-runtimes/</a></li>
<li><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/666200234">https://zhuanlan.zhihu.com/p/666200234</a></li>
<li><a target="_blank" rel="noopener" href="https://www.qikqiak.com/k8strain2/containerd/runtime/">https://www.qikqiak.com/k8strain2/containerd/runtime/</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/kubernetes/cri-api/tree/master/pkg/apis">https://github.com/kubernetes/cri-api/tree/master/pkg/apis</a></li>
<li><a target="_blank" rel="noopener" href="http://www.opennaru.com/kubernetes/containerd/">http://www.opennaru.com/kubernetes/containerd/</a></li>
<li><a target="_blank" rel="noopener" href="https://www.slideshare.net/AkihiroSuda/container-plumbing-days-2023-why-was-nerdctl-made">https://www.slideshare.net/AkihiroSuda/container-plumbing-days-2023-why-was-nerdctl-made</a></li>
<li><a target="_blank" rel="noopener" href="https://www.alibabacloud.com/blog/a-discussion-on-container-runtime---starting-with-dockershim-being-deleted-by-kubernetes_600118">https://www.alibabacloud.com/blog/a-discussion-on-container-runtime---starting-with-dockershim-being-deleted-by-kubernetes_600118</a></li>
</ol>

  </div>
</article>



        
          <div id="footer-post-container">
  <div id="footer-post">

    <div id="nav-footer" style="display: none">
      <ul>
        
          <li><a href="/">Home</a></li>
        
          <li><a href="/about/">About</a></li>
        
          <li><a href="/categories/">Category</a></li>
        
          <li><a href="/archives/">Writing</a></li>
        
          <li><a target="_blank" rel="noopener" href="http://github.com/zouyee">Projects</a></li>
        
      </ul>
    </div>

    
    
      <div id="toc-footer" style="display: none">
        <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%83%8C%E6%99%AF%E4%BB%8B%E7%BB%8D"><span class="toc-number">1.</span> <span class="toc-text">背景介绍</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%8A%80%E6%9C%AF%E8%83%8C%E6%99%AF"><span class="toc-number">2.</span> <span class="toc-text">技术背景</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#OCI-%E6%A0%87%E5%87%86-%EF%BC%88Open-Container-Initiative%EF%BC%89"><span class="toc-number">2.1.</span> <span class="toc-text">OCI 标准 （Open Container Initiative）</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Containerd"><span class="toc-number">2.2.</span> <span class="toc-text">Containerd</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#CRI"><span class="toc-number">2.3.</span> <span class="toc-text">CRI</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%91%BD%E4%BB%A4%E8%A1%8C%E7%9B%98%E7%82%B9"><span class="toc-number">3.</span> <span class="toc-text">命令行盘点</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#nerdctl"><span class="toc-number">3.1.</span> <span class="toc-text">nerdctl</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Containerd%E4%BD%BF%E7%94%A8%E6%8C%87%E5%8D%97"><span class="toc-number">4.</span> <span class="toc-text">Containerd使用指南</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-%E5%AE%89%E8%A3%85"><span class="toc-number">4.1.</span> <span class="toc-text">1. 安装</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-%E5%91%BD%E4%BB%A4%E7%AE%80%E4%BB%8B"><span class="toc-number">4.2.</span> <span class="toc-text">2. 命令简介</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%AE%B9%E5%99%A8%E7%AE%A1%E7%90%86"><span class="toc-number">4.2.1.</span> <span class="toc-text">容器管理</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%95%9C%E5%83%8F%E7%AE%A1%E7%90%86"><span class="toc-number">4.2.2.</span> <span class="toc-text">镜像管理</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#compose"><span class="toc-number">4.2.3.</span> <span class="toc-text">compose</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#CRICTL%E4%BD%BF%E7%94%A8%E6%8C%87%E5%8D%97"><span class="toc-number">5.</span> <span class="toc-text">CRICTL使用指南</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-%E5%AE%89%E8%A3%85-1"><span class="toc-number">5.1.</span> <span class="toc-text">1. 安装</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-%E5%91%BD%E4%BB%A4%E7%AE%80%E4%BB%8B-1"><span class="toc-number">5.2.</span> <span class="toc-text">2. 命令简介</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%93%BE%E6%8E%A5"><span class="toc-number">6.</span> <span class="toc-text">链接</span></a></li></ol>
      </div>
    

    <div id="share-footer" style="display: none">
      <ul>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.facebook.com/sharer.php?u=https://zoues.com/posts/3881eb8f/"><i class="fab fa-facebook fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://twitter.com/share?url=https://zoues.com/posts/3881eb8f/&text=Dockerless：Containerd方案"><i class="fab fa-twitter fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.linkedin.com/shareArticle?url=https://zoues.com/posts/3881eb8f/&title=Dockerless：Containerd方案"><i class="fab fa-linkedin fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://pinterest.com/pin/create/bookmarklet/?url=https://zoues.com/posts/3881eb8f/&is_video=false&description=Dockerless：Containerd方案"><i class="fab fa-pinterest fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=Dockerless：Containerd方案&body=Check out this article: https://zoues.com/posts/3881eb8f/"><i class="fa-solid fa-envelope fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://getpocket.com/save?url=https://zoues.com/posts/3881eb8f/&title=Dockerless：Containerd方案"><i class="fab fa-get-pocket fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://reddit.com/submit?url=https://zoues.com/posts/3881eb8f/&title=Dockerless：Containerd方案"><i class="fab fa-reddit fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.stumbleupon.com/submit?url=https://zoues.com/posts/3881eb8f/&title=Dockerless：Containerd方案"><i class="fab fa-stumbleupon fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://digg.com/submit?url=https://zoues.com/posts/3881eb8f/&title=Dockerless：Containerd方案"><i class="fab fa-digg fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.tumblr.com/share/link?url=https://zoues.com/posts/3881eb8f/&name=Dockerless：Containerd方案&description="><i class="fab fa-tumblr fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://news.ycombinator.com/submitlink?u=https://zoues.com/posts/3881eb8f/&t=Dockerless：Containerd方案"><i class="fab fa-hacker-news fa-lg" aria-hidden="true"></i></a></li>
</ul>

    </div>

    <div id="actions-footer">
        <a id="menu" class="icon" href="#" onclick="$('#nav-footer').toggle();return false;"><i class="fa-solid fa-bars fa-lg" aria-hidden="true"></i> Menu</a>
        
          <a id="toc" class="icon" href="#" onclick="$('#toc-footer').toggle();return false;"><i class="fa-solid fa-list fa-lg" aria-hidden="true"></i> TOC</a>
        
        <a id="share" class="icon" href="#" onclick="$('#share-footer').toggle();return false;"><i class="fa-solid fa-share-alt fa-lg" aria-hidden="true"></i> Share</a>
        <a id="top" style="display:none" class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fa-solid fa-chevron-up fa-lg" aria-hidden="true"></i> Top</a>
    </div>

  </div>
</div>

        
        <footer id="footer">
  <div class="footer-left">
    Copyright &copy;
    
    
    2016-2024
    zouyee
  </div>
  <div class="footer-right">
    <nav>
      <ul>
        <!--
       --><li><a href="/">Home</a></li><!--
     --><!--
       --><li><a href="/about/">About</a></li><!--
     --><!--
       --><li><a href="/categories/">Category</a></li><!--
     --><!--
       --><li><a href="/archives/">Writing</a></li><!--
     --><!--
       --><li><a target="_blank" rel="noopener" href="http://github.com/zouyee">Projects</a></li><!--
     -->
      </ul>
    </nav>
  </div>
</footer>

    </div>
    <!-- styles -->



  <link rel="preload" as="style" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" crossorigin="anonymous" onload="this.onload=null;this.rel='stylesheet'"/>


    <!-- jquery -->

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js" crossorigin="anonymous"></script>




<!-- clipboard -->

  
    <script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.7/clipboard.min.js" crossorigin="anonymous"></script>
  
  <script type="text/javascript">
  $(function() {
    // copy-btn HTML
    var btn = "<span class=\"btn-copy tooltipped tooltipped-sw\" aria-label=\"Copy to clipboard!\">";
    btn += '<i class="fa-regular fa-clone"></i>';
    btn += '</span>';
    // mount it!
    $(".highlight table").before(btn);
    var clip = new ClipboardJS('.btn-copy', {
      text: function(trigger) {
        return Array.from(trigger.nextElementSibling.querySelectorAll('.code')).reduce((str,it)=>str+it.innerText+'\n','')
      }
    });
    clip.on('success', function(e) {
      e.trigger.setAttribute('aria-label', "Copied!");
      e.clearSelection();
    })
  })
  </script>


<script src="/js/main.js"></script>

<!-- search -->

<!-- Baidu Analytics -->

<!-- Cloudflare Analytics -->

<!-- Disqus Comments -->

<!-- utterances Comments -->

</body>
</html>
